---


```{r 'check_ps', include=FALSE}

user.name = '' # set to your user name

library(RTutor)
check.problem.set('NAFTA', ps.dir, ps.file, user.name=user.name, reset=FALSE)

# Run the Addin 'Check Problemset' to save and check your solution
```

output: html_document
---
# Problem Set NAFTA

Example of an RTutor Interactive Problem Set  
Author: Tobias Fischer  
Date: May 10, 2016  



## Exercise Content

```
  Introduction

  1.  The Given Data

    1.1. Tariffs

    1.2. Tariffs and Values of Exports
  
    1.3. Input-Output Coefficients
  
  2.  The Model  

    2.1. Model Specifications (Efficiency of Production)
 
    2.2. The Frechet Distribution in Eaton and Kortum (2002)

    2.3. Model Specifications (Households, Intermediate Goods, Costs and Prices)
  
    2.4. Other Necessary Parameters and Formulae
  
    2.5. Model Specifications (Expenditure and Expenditure Shares)
 
    2.6. The Equilibrium
  
  3.  Code for Finding the Equilibrium and Welfare Effects

    3.1. Solving for Costs and Prices - Equations 6 & 7
  
    3.2. Solving for Expenditure Shares - Equation 8
  
    3.3. Solving for Expenditures - Equation 9
  
    3.4. Checking if the Trade Balance and Labour Market Clearing Hold - Equation 10
  
    3.5. Welfare Effects of Tariff Changes

  4.  The Model's Results

    4.1. Effects from NAFTA Tariff Reductions

    4.2. Effects from World Tariff Reductions
    
  5.  Trade Elasticities

    5.1. Visualization of Theta
   
  6.  Conclusion, Related Literature and TTIP

  Glossary of Terms

  References
```

<br>

<br>

  
## Exercise Introduction

Welcome to the interactive **RTutor problem set NAFTA**.  
NAFTA is an acronym for the North American Free Trade Agreement between Mexico, the United States and Canada which came into force on January 1, 1994. It is considered an archetypal trade agreement due to its size and because of building cross-border value chains between heterogeneous countries on different development levels.   

In the course of this problem set, you will have the opportunity to learn lessons from NAFTA and obtain some interesting insights into

- NAFTA's impacts on the participating economies, 

- a methodology of how free trade agreements are modelled in the literature, 

- the programming language R  

- instructive publications on NAFTA and

- implications for future free trade agreements like the Transatlantic Trade and Investment Partnership (TTIP).

<br>

The core of this RTutor problem set is the article **Estimates of the Trade and Welfare Effects of NAFTA** by Caliendo and Parro (2015), hereafter denoted CP. They develop a general equilibrium model, a standard tool for international trade evaluation. CP's model is based on a Ricardian gravity trade model by Eaton and Kortum (2002), hereafter denoted EK. It considers geography and technology as factors for trade. More on the model's most general characteristics is presented in Exercise 2. 

CP's aim is to identify the impact of the tariff reductions in the course of NAFTA on welfare in the NAFTA member states and trade between them. They find that large increases in trade volumes arise from NAFTA tariff reductions, while the impact on wages and welfare is rather low.

<br>


This RTutor problem is mainly based on CP's findings, model and freely available data. The problem set's contribution is in its interactive design to show you main aspects of CP's work and facilitate understanding it. Despite the underlying article being scientific and complex, the goal here is to convey information in an appealing way. Numerous calculations in interactive code chunks and quizzes have the purpose that you can apply directly the acquired knowledge and provide little breaks for recapitulation. There will also be many parts with supplemental information, so that you can choose yourself how intensely you work with the single elements you get to know. The optional parts are indicated and can be skipped without losing track of the main aspects of CP's work.



This RTutor problem set is available at: https://github.com/fischeruu/RTutorNAFTAfreetrade.
Kranz (2015) provides links to this and further problem sets at: https://github.com/skranz/RTutor.

<br>


Here is a warm-up. Have you already heard about NAFTA? **Your task:** Solve this first quiz! In the course of this problem set there will be many quizzes in which you can test your knowledge and recap the information provided. Press the `check` button after having selected your answer choices. Do not worry: If there was a wrong answer, `RTutor` would tell you this and lets you choose another answer option.

#! addon__quiz__Have you already heard about NAFTA?


<br>

#### The Structure of this RTutor Problem Set

Exercise 1 presents a brief introduction of how you can handle an RTutor problem set and also the most important features of the data we work with. In Exercise 2, CP's model's features, the important variables and the definition of the equilibrium the model results in are introduced. The code for solving the equilibrium is available in Exercise 3.
Exercise 4 gives the most important results that CP find. In Exercise 5 you can learn more about the model's most important parameters, the trade elasticities. Exercise 6 provides a discussion on free trade areas' effects, both with the results from CP's work and with related literature. Additionally, a brief comment on the TTIP (a free trade agreement between the USA and the European Union) negotiations is given. The last two exercises contain a glossary of terms and the references. In case you do not understand an abbreviation, you can simply click on 'Glossary of Terms' in the top area of the page to access it. To see the references, click on 'References'.



At the top of every page, you find the navigation bar, where you can directly jump to the exercise you wish to. Additionally, headwords of the main exercises are shown.

<br>

<br>


## Exercise 1 - The Given Data

If this is the first **RTutor problem set** you work on, you might want to learn something about the functionality. In that case, expand the note block below by clicking on it.

#! start_note "Note: Click here to learn something about the very basics of RTutor problem sets"
This is a note block. It will explain you some basic things about working in this environment.  
Now you know how to access a note block. An info block looks and works very similar, it just adds the word 'Info:' in its title. However it does not allow for code chunks inside the block, unlike note blocks.
info("Info blocks") # Run this line (Strg-Enter) to show info
Info blocks are optional. Whenever you are asked to perform an action, this is indicated by a sentence containing **your task**.

The main tool you will work with in a problem set are **code chunks**, where you will often enter `R` code. Often, though, the code is already given and only needs to be checked (you will soon see how).  
In the following code chunk it is **your task** to press the `hint` button, so that you can see the exact instruction. Then enter the correct code. Finally press the `check` button to evaluate your solution. If you do not have the time to figure out the correct command, you can always press the `solution` button to see a possible solution. You can then simply check it to complete the code chunk.   
It is important that there is no hash key `#` in front of the code that you want to execute. On the other hand, comments cannot be interpreted by the programme and need a hash key `#` in front of them, for example `# Enter your command here`. 
```{r "1___The_Given_Data",optional=TRUE, eval=FALSE, points=0}
# Enter your command here

```
Note that sometimes when there is no `check` button visible, first click on `edit` so that `check` appears. Assignations of variables can be done by the commands `=` and `<-`, i.e. instead of `nafta = c("Canada","Mexico","USA")` you can write `nafta <- c("Canada","Mexico","USA")`.

<br>

Another frequent element of a problem set is a quiz. In the introduction you already solved one, here is another example how it works.
As always, what you are asked to do is indicated similar to the following:  
**Your task:** Solve the quiz and press the `check` button.

#! addon__quiz__Introduction test

<br>

Sometimes there will be empty code chunks that you can use in order to perform calculations that are useful for solving the quiz. Those code chunks are optional and recommended to use autonomously.  

In contrast to code chunks, quizzes need not be solved correctly in order to be able to advance to the next code chunks. In the navigation area at the top of each page you can always jump to other exercises. Furthermore, the symbol on the right-hand side of `Data Explorer` shows how many points you earned throughout this problem set. You can earn points by executing correct commands in code chunks and by correctly answering quizzes.

Now you know the basics tools you need to solve the problem set presented here.

#! end_note

<br>

Exercises 1 to 1.3 will present the most important features of the data CP work with. Basically, this data is stored in the data frames `trade` and `io`. In Exercise 1 you will learn some basic data frame commands in `R` and get to know the countries and sectors which play a role in CP's model and for which we have data available.

<br>

#### a) Loading the Data
**Your task:** Read in the data frame `trade` which is saved in `trade.csv` and the data frame `io` which is stored in `io.csv`. So simply press the `edit` button first, to let the `check` button appear, or press directly the `check` button if possible.
```{r "1___The_Given_Data__2"}
trade <- read.csv("trade.csv")
io <- read.csv("io.csv")
```

<br>


#### b) The Data Frame `trade`
Let us have a first glance at the data frame `trade`. Values are given in million dollars (trade volume and gross output) or in percent (tariffs, value added rate and trade elasticities). We also have factor variables for the sector, the source and destination countries of trade flows and the tradability of sectors and for the NAFTA membership of countries.  
For descriptions of the variables in data frames, click on the `data` button on top of a code chunk. There you can select the data frames you loaded in the current exercise and press `Description` for the descriptions.  
**Your task** is to just check this chunk in order to have this quick glance on the top rows of the data frame `trade`.
```{r "1___The_Given_Data__3"}
head(trade,4)
```
With the help of this solved code chunk, with the use of the `data` button and with selecting the data frame `trade` it is **your task** now to solve the following quick quiz. If you do not know the answer, just click the `check` button and a hint will appear. You may then answer the question again.

#! addon__quiz__Handling quiz

<br>

In the following you will get to know better what this data frame includes.

<br>


#### c) Sectors
There are 40 sectors in the model. The first 20 sectors are tradable, the remaining 20 sectors are non-tradable. Goods from non-tradable sectors are only available within one country, they represent the infrastructure.  
**Your task** is to check this chunk in order to have a look at the sectors we work with.
```{r "1___The_Given_Data__4"}
unique(trade$Sector)
```


Below the following code chunk there is a quiz about the data frame `trade`.  
**Your task:** In order to solve the quiz you may use the following code chunk. If you need help, press the `hint` button on top of the code chunk.
```{r "1___The_Given_Data__5",optional=TRUE}
# Enter your code here
# do not forget to remove the hash keys `#`
```

#! addon__quiz__Exploring the data frame trade

<br>



#### d) Countries 

Another way to obtain all the different entries in a column of the data frame is the command `levels()`. Note that unlike the `unique()` command, with `levels()` the countries are ordered alphabetically. 

**Your task:** Use the command `levels()` in order to get a list of the countries (here; source countries `Source_C`) included in the data frame. Do not forget to remove the hash keys `#`. If you need help, press the `hint` button.
```{r "1___The_Given_Data__6"}
# Enter your command here

```
Note that there is a constructed `Remaining World` for all the countries where there is not sufficient data available. It is introduced into the model to capture trade globally.

**Your task** is to simply check the following chunk. This gets you a world map with some coloured countries. NAFTA member states appear red-coloured and countries that the data includes explicitly are yellow-coloured. All the other countries' data is included in a constructed `Remaining World`.
```{r "1___The_Given_Data__7",fig.height=9, fig.width=12}
printmap(trade, io)
```

<br>

If you want to know how the world map plot above is implemented in the self-written function `printmap()`, you may access the following note. Otherwise just continue with the final quiz of this exercise.

#! start_note "Note: The code of the self-written function `printmap()`"
This note shows how the function `printmap()` is implemented. Note that the function `map_data()` is part of the `ggplot2` package and returns the coordinates of the area specified in the brackets (here: `world`).
```
printmap <- function(trade,io,nafta){    

  world <- map_data("world")
  nafta <- c("Canada","Mexico","USA")
  
  ## the following line is just put here to give an example of how `world` looks like
  ## these are the longitudinal and latitudinal coordinates of the polygonal corner 
    ## points which together form the single countries on the global coordinate system
  head(world)

  mapPaper <- filter(world, 
      is.element(region,c(levels(io$Country),"South Africa", "South Korea")))
  mapNafta <- filter(world, is.element(region,nafta))
  mapROW <- filter(world, 
      !is.element(region,c(levels(io$Country),"South Africa", "South Korea")))
  
  map_world <- ggplot() +
    geom_polygon(data=mapPaper, aes(x=long, y=lat, group=group), fill="orange") +
    geom_polygon(data=mapNafta, aes(x=long, y=lat, group=group), fill="red") +
    geom_polygon(data=mapROW, aes(x=long, y=lat, group=group), fill="grey77") +
    geom_path(data=world, aes(x=long, y=lat, group=group)) +
    scale_y_continuous(breaks=30*(-2:2)) +
    scale_x_continuous(breaks=45*(-4:4)) +
    theme(panel.grid.minor = element_blank(), 
          panel.grid.major = element_line(colour="grey"),
          panel.background = element_rect(fill = "white"))
  map_world
}
```

In order to see how the data base which is used for plotting the world looks like, **your task** is to check the following chunk.
```{r "1___The_Given_Data__8",points=0}
head(map_data("world"))
```

#! end_note

<br>



**Your task** now consists of answering these two questions on the countries covered by the available data.
#! addon__quiz__The countries covered by the available data



<br>

## Exercise 1.1 -- Tariffs
CP aim at analysing effects of tariff reductions in the course of a free trade agreement. Hence, we need data on tariffs for this problem set. This exercise introduces how the tariff data is stored here.

Since variables are not saved after page breaks respectively for new exercises, we have to make the required variables available again to `RTutor`. 
**Your task** is again to read in the data frame `trade`, which is saved in `trade.csv`. First you need to click on `edit`, then on `check`.

```{r "1_1"}
trade <- read.csv("trade.csv")
```

In the rows `Tariffs1993` and `Tariffs2005` you can find the respective Tariffs in percent for the years 1993 and 2005 for each sector for each pair of importing/exporting country. Note that, without loss of generality, in all non-tradable sectors the values are set equal to $0$, since no trade and tariffs exist.

<br>


#### a) An Example of Tariffs and its Changes within NAFTA
To get a first impression of tariffs within NAFTA, the next code chunk is prepared for you. It gives all sectors and their respective tariffs in 1993 and 2005 that Mexico imposed on imports from the USA.
**Your task** is to check this chunk.
```{r "1_1__2",signif.digits=3}
trade %>%
  filter(Dest_C=="Mexico", Source_C=="USA") %>%
  select(Sector, Tariffs1993, Tariffs2005, Tradable)
```
Note that the second 20 rows/sectors all have tariffs equal to zero. To see why this is the case, consider the column `Tradable`. It only has the entries `0` and `1`, meaning `FALSE` and `TRUE`. It indicates if the goods produced in the respective sector are tradable or not, i.e. if they can be sold to another country.  
Therefore, we can see that the sectors in the rows 21 to 40 are non-tradable and consequently cannot have tariffs imposed on their goods. This is why we set their tariffs equal to $0$.

Further note that in the data frame the tariffs are given sector-wise. Usually there are no tariffs applicable for whole sectors. So the tariffs given here are weighted averages according to the trade volumes of types of goods within the sectors.


<br>

We now will gradually develop a reasonable way of the tariff development's visualization. The final plot which is quite suitable for the demonstration purpose will be shown in Exercise 1.2 b).

<br>


#### b) Arithmetic Average of Tariffs and its Issues
For now, let us have a first view of the evolution of tariffs between 1993 and 2005, especially for the NAFTA members. Therefore, in a first step calculate the arithmetic average, conditionally on if the respective country is NAFTA member or not. This latter information is contained in the column `NAFTA_Dest`, the following info box offers more details.

info("The column NAFTA_Dest") # Run this line (Strg-Enter) to show info

Therefore, create a data frame `pp1`. The code is given for you, executing it is **your task**. 
```{r "1_1__3",signif.digits=3}
pp1 <- trade %>%
  group_by(NAFTA_Dest) %>%
  summarize(Tariffs_avg = mean(Tariffs1993), Tariffs_avg_05=mean(Tariffs2005))
pp1
```

<br>

Until now, in the data frame `pp1` we calculated the arithmetic average over all sectors. However we know already that there are non-tradable sectors where the tariffs are arbitrarily set equal to $0$. If you want to find out why there are non-tradable sectors in CP's model at all, see the following info box.

info("Non-tradable sectors") # Run this line (Strg-Enter) to show info
So in order to calculate appropriate average tariffs, we should restrict the data frame to tradable sectors. Consider the following example in which we take the average tariff only over the tradable sectors. 
Therefore it is **your task** to perform the same calculations as in the above code chunk, adding a filter such that `Tradable==1`. Do not forget to remove the hash keys `#`.
```{r "1_1__4",signif.digits=3}
#pp1b <- trade %>%
  ## Enter the additional code here || but do not quit the  %>%
#  group_by(NAFTA_Dest) %>%
#  summarize(Tariffs_avg = mean(Tariffs1993), Tariffs_avg_05=mean(Tariffs2005))
#pp1b

```

The result in the data frame `pp1b` clearly shows the expected behaviour, namely the doubling of the arithmetic average. See the info box for an explanation:

info("Doubling the arithmetic average") # Run this line (Strg-Enter) to show info

Having obtained the adequate data frame, **your task** is now to plot it by checking the following chunk.
```{r "1_1__5"}
pplot1b <- ggplot(pp1b) + 
  geom_bar(mapping=aes(x=NAFTA_Dest, y=Tariffs_avg),stat="identity",  
           fill="lightblue", colour="lightblue4") + 
  geom_bar(mapping=aes(x=NAFTA_Dest, y=Tariffs_avg_05),stat="identity", 
           fill="darkorange", colour="orangered")
pplot1b

```


<br>

After comparing the plot with the output of the second code chunk in this part b), **your task** is to answer the following questions on the bar plot and the underlying data.

#! addon__quiz__Understanding the bar plots

<br>

Note that in Exercises 1.1 and 1.2, the meanings of the light blue and the dark orange parts of the plot stay as in the quiz and as in the preceding bar plot.
Now continue with Exercise 1.2 to learn more about tariffs and other variables we will need.

<br>


## Exercise 1.2 -- Tariffs and Values of Exports

In this exercise, we will introduce the values of trade flows and analyse them jointly with the tariffs. Further columns in the data frame `trade` are presented in part c).

As a preparation for further calculations we need to load the data again, which is **your task**.
```{r "1_2"}
trade <- read.csv("trade.csv")  
```


#### a) Weighted Average of Tariffs 

In Exercise 1.1, we created data frames and plots of arithmetic averages. A disadvantage of the arithmetic average of all tariffs is, that it does not give much evidence about the overall tariff load imposed on imports in general.

So a more convenient approach for a meaningful summary of the development of tariffs is the weighted average.  
To calculate this value, we need corresponding trade volumes additionally to the respective sectoral tariffs in 1993 and 2005. Here, analogously to CP's work, we only consider trade volumes of 1993 for the main calculations. In order to obtain the results they aim at, CP make a 'ceterus paribus' - or 'other things being equal' - assumption: They 'calibrate' their model to the year 1993. Tariffs are the only parameters that change in their model and that are therefore the basis for their evaluation of trade and welfare effects. 

Values of exports in 1993 are given on a sectoral basis between all possible exporter-importer pairs in the column `Trade_Vol`. Analogously to the tariffs, they are equal to $0$ for non-tradable sectors. `Trade_Vol` gives values in million dollars.

<br>


To have a quick glance at tariffs and the corresponding trade volumes, **your task** is to add to the output in part a) the column for the traded value. Restrict the view to only the relevant information, namely to tradable sectors. You may filter according to `Tradable == 1`.
```{r "1_2__2",signif.digits=4}
# trade %>% 
# Enter your code here
# Enter your code here

```




<br>


**Your task:** Now enter yourself the code to calculate the weighted averages grouped by NAFTA destinations, similar to the first code chunk in part b). To obtain weighted averages, multiply the tariffs with the (corresponding) trade volume and divide its sum by the total trade volume. Name the weighted average of tariffs in 1993 `Tariffs_weighted` and name its counterpart for 2005 `Tariffs_weighted_05`.
```{r "1_2__3",signif.digits=3}
# pp2 <- trade %>%
  # ??? (???) %>%
  # ??? (Tariffs_weighted = ,
  #          Tariffs_weighted_05=)
# pp2

```

<br>


How does the corresponding plot look like? To solve **your task** substitute the question marks `???` with the right expressions.
```{r "1_2__4",points=1}
#pplot2 <- ggplot( ??? ) + 
#  geom_bar(mapping=aes(x= ??? , y= ??? ),stat="identity",  
#      fill="lightblue", colour="lightblue4") + 
#  geom_bar(mapping=aes(x= ??? , y= ??? ),stat="identity", 
#      fill="darkorange", colour="orangered")
#pplot2

```

Note that the meanings of the light blue and the dark orange parts of the plot stay the same in Exercises 1.1 and 1.2. Their meanings are explained exemplarily for the bar plot in Exercise 1.1 b).

<br>
**Your task**: Now it is time for you to answer some questions on the results we have obtained so far. You may use the following free code chunk if you want to.

```{r "1_2__5",optional=TRUE}
# enter code freely here if you wish to
```

#! addon__quiz__Summary of Exercise 1.2 part a)

<br>


#### b) Tariffs According to Country of Origin
Now we already have created a pretty descriptive plot which illustrates how tariffs evolved between 1993 and 2005, both for the NAFTA member states and for the non-member states. Now from the significant reduction of tariffs in the countries beyond NAFTA arises one question: To what extent do the tariff reductions of Canada et al. actually arise from NAFTA and not from general tariff reductions or due to other bilateral agreements or free trade agreements? In the case of Mexico, for instance, at least ten more free trade agreements came into force between 1994 and 2004, a free trade agreement with the European Union in 2000 amongst them.  
To address this issue, **your task** is to check the following code chunk. It calculates and prints the weighted average of tariffs, separately calculated according to importation from NAFTA members and from non-NAFTA members. 
```{r "1_2__6"}
printplot3(trade)
```

As we can conclude, effective import tariffs were substantially reduced in the whole world between 1993 and 2005. The import tariffs in Mexico decreased importantly from 1993 to 2005, both from Canada/USA, as well as from the remaining world. The decrease in effective tariffs was extremely strong according to the NAFTA agreement, which made them fall to almost zero. Tariffs between Canada and the U.S. were already very low in 1993 due to a free trade agreement between both states signed in 1988, thus the changes that arose from NAFTA were not so pronounced in the case of these two countries.  

#! start_note "Note: The code of the self-written function `printplot3()`"
In this note you see how to get the plot in part d). Since it is a little too complex for the core RTutor problem set it is put here for the most interested readers.

```
printplot3 <- function(trade,nafta){    

  nafta <- c("Canada","Mexico","USA")

  pp3 <- trade %>%
    mutate(NAFTA_Source=ifelse(is.element(Source_C,nafta),"NAFTA","World_beyond")) %>%
    group_by(NAFTA_Dest,NAFTA_Source) %>%
    summarize(Tariffs=sum(Trade_Vol*Tariffs1993)/sum(Trade_Vol), 
              Tariffs05=sum(Trade_Vol*Tariffs2005)/sum(Trade_Vol)) 
  print(pp3)
  
  pplot3 <- ggplot(pp3) + 
    geom_bar(mapping=aes(x=NAFTA_Source, y=Tariffs),stat="identity", 
             position=position_dodge(0.8),  fill="lightblue", colour="lightblue4") +
    geom_bar(mapping=aes(x=NAFTA_Source, y=Tariffs05),stat="identity", 
             fill="darkorange", colour="orangered") +
    facet_grid(.~NAFTA_Dest)
  pplot3
  
 }
```

So you see that the code of the function `printplot` simply uses the commands we already have seen in the plotting code chunks above. The first exception is `position=position_dodge(0.8)` where `position_dodge()` allows to "Adjust position by dodging overlaps to the side" (Wickham and Chang, 2015), namely it lets the single bars be placed next to each other. Otherwise the bars for `NAFTA` and `World_beyond` would be stacked by default. The second exception is `facet_grid(.~NAFTA_Dest)` which is responsible for the creation of the four sub-plots for Canada, Mexico, USA and World_beyond as `NAFTA_Dest` variable levels.

#! end_note






<br>



#### c) Other Columns Given in `trade`
* `GO_Source` is the gross output in the given sector of the country stated in `Source_C`. The values are given in million dollars. 

* `VA_Source` states the value added coefficient for the given sector in the source country `Source_C`. That means, it says which percentage of the value of the final product in this sector is added within the sector and not created by the inputs. Note that this value differs from country to country.

You may see a discussion on both variable names in the info box "The variable names `GO_Source` and `VA_Source`.

<br>

info("The variable names 'GO_Source' and 'VA_Source' ") # Run this line (Strg-Enter) to show info
 
<br>

Due to the ambiguity issue discussed in the info box above, we cannot access the values for gross output and value added coefficient directly and intuitively. To see this, **your task** is to insert the variable for gross output in the following code chunk, in which we get the gross output of the Mexican automotive sector.
```{r "1_2__7"}
  # replace the ??? by the correct expressions
#trade %>%
#    filter(Source_C==" ??? ",Sector==" ??? ") %>%
#    select(Source_C, Sector, ??? )

```

Of course, here you can see what the gross output of the Mexican automotive sector is. In contrast, if you try calculate with this value, as you might want to in the tasks that will follow, this representation is not suitable. Therefore you could employ simple methods to obtain just one row as an output, using commands like `first()`, `distinct()`, or the trick of inserting an (arbitrary) destination country into the filter. Certainly you can think yourself of an easy example and implement it in the free code chunk right before the final quiz of this exercise.


<br>

* `Trade_Elast` is the variable that gives the trade elasticities. These are the only parameters that are needed to be estimated for the model, since they cannot be extracted easily from existing data. Trade elasticities are sector-specific parameters and indicate how strongly changes in prices or tariffs affect trade flows in this sector. They are estimated in Exercise 'Trade Elasticities'.     
As `VA_Source`, `Trade_Elast` is given in percent.

<br>

Now, as you got to know all the columns of the data frame `trade`, let us visualize what we learned about the data so far. **Your task:** just check the code chunk as you did it in Exercise 1 b).
```{r "1_2__8",signif.digits=4}
sample_n(trade,5)
```
The function `sample_n()` shows a certain number of random rows (the second argument) of a data frame (the first argument).

<br>


Finishing the introduction of the data frame `trade` and summarizing the latter results from this exercise, **your task** is to do a quiz. You may use the free code chunk if you wish to.

```{r "1_2__9",optional=TRUE}
# enter code freely here if you wish to
```

#! addon__quiz__Summary of Exercise 1.2 from part b) on


<br>


## Exercise 1.3 -- Input-Output Coefficients
CP suggest that sectoral linkages are important for the quantification of trade agreement effects. Consequently, they employ data that provides information on inter-sector connections. This exercise presents their data and some of its characteristics.

<br>

Global value chains tend to slice a production process into increasingly smaller tasks, they become more and more fragmented. In 1993 for example, the imports of intermediate goods represented more than 60% of total imports in each of the three NAFTA members Mexico, Canada and the U.S.   


In order to model and grasp the interconnectivity between sectors, countries and also value chains, input-output (I-O) relationships play an important role. As a consequence, they are also important for CP, since they try to find a global equilibrium of trade and welfare.
CP mainly work with world input-output tables (WIOT) which are freely available, see the link below Figure 1. Additionally they integrate data from OECD I-O tables.   
The different types of I-O tables have slightly different information purposes, requirements for source reliabilities and so on. However, the general idea of such an I-O table is very close to how the OECD describes I-O tables:


> "A coefficient (input-output) table records [...] the amount of output by each industry used as input [...] of the various products/industries." 

  > *Source: OECD Glossary (2016) - http://stats.oecd.org/glossary/detail.asp?ID=373*
  


<br>


Figure 1 shows how the WIOT from 1995 looks like in the first few rows and columns, where 'AUS' stands for Australia. Columns stand for destination sectors with their, while rows represent source sectors of material flows. The green parts of the first row/column give the abbreviation keys for the sectors that stands in the respective row/column.

![The top left of the world input-output table](WIOT_Example.jpg)
 > Figure 1 - The top left of the world input-output table
 
 > *Source: World Input-Output Database (2016) - http://www.wiod.org/new_site/database/wiots.htm*

"...The columns in the WIOT contain information on production processes. When expressed as ratios to gross output, the cells in a column provide information on the shares of inputs in total costs (Timmer et al. (2015)). ..."   
These shares of inputs in total costs are what CP provide in their work's supplemental data. Note that the WIOT matrix has strong diagonals, which means that materials that one sector uses often stem from the same sector. For more information on the construction of the WIOT, see Dietzenbacher et. al (2013).

<br>

**Your task** now is to answer three questions on the given WIOT.


#! addon__quiz__The WIOT table

<br>

If you want to get more details about the I-O data and the data CP provide, see the following note.

#! start_note "Note: A brief discussion on the I-O data"
For our work with I-O coefficients it is noteworthy that CP sector wisely aggregate the data the WIOT provides. In other words, the WIOT answers to a question as, for example: Which *value* of material/intermediate consumption from sector A in country 1 does sector B in country 2 use? The data CP use only answers to: In a given country, which *part* of the value of material/intermediate consumption input into sector Y comes from sector Z? So CP ignore the information on the materials' distribution on countries of origin. Apparently this fits better to their model which we will get to understand better in Exercise 2. Note that, in this example, country 1 may be the same as country 2, as well as sector A may be identical to sector B.  
Note further that the way the exemplifying questions in this bullet point are asked corresponds to a column-wise reading of the data. One column stands for one sector that gets inputs. A row-wise reading of the WIOT would rather correspond to questions like: Which amount of the output of sector C in country 3 is used as material in sector D in country 4 (or as final consumption good by households or by the government in country 5)?

<br>

For those who want to work with the original data that CP provide, consider the following possible error in CP. Maybe, CP commit a slight explanation mistake in their supplemental data, namely in the 'README.pdf' file. There they give descriptions of their input data. For example, they describe that in their input-output data 'IO.txt' rows stood for destination sectors while columns represented source sectors. It looks like they switch the correct assignation, since each column describes the inputs into a whole sector, which should make this sector to the *destination* sector. The column names 'Dest\_S' and 'Source\_S' in the data frame 'io' directly depend on this description.  
On the other hand, the calculations that CP perform fit well to the description of the input data 'IO.txt' and thus to the data frame 'io' in this exercise. They therefore seem to contradict their own data description in the case of 'IO.txt'.

#! end_note

<br>


#### a) A Quick Glance at the Data Frame `io`

  
Again, we need to load the data. **Your task:** Read in the data frame `io` saved in `io.csv`. The code is already given, so you only need to press the `edit` button, then the `check` button.
```{r "1_3"}
io <- read.csv("io.csv")
trade <- read.csv("trade.csv")
```


In the data frame `io`, values are given in percent.
**Your task** now: Filter the data frame so that we can see all the I-O coefficients with the Australian food sector as destination sector. You can just check the chunk.
```{r "1_3__2",signif.digits=3}
filter(io, Country=="Australia", Dest_S=="Food")
```


The entries of this filtered data frame represent the single sectors' shares of inputs into the food sector. Consequently, keeping the food sector as destination sector fixed, the entries sum up to 1. 

For that purpose, **your task** is to calculate these 100 percent with the help of the chunk above.
```{r "1_3__3",signif.digits=3}
#summarize(filter( ??? , Country==" ??? ", ??? =="Food"), total=sum( ??? ))

```

<br>
Let us have a look again on the output of the penultimate chunk above. As expected, the material input that agriculture provides to the food sector is pretty high, about one third of total inputs. As usual, the input from food into food is also important, which again demonstrates the strong diagonal in the WIOT.

Seemingly, the values in `io` do not have anything in common with the data the WIOT provides. Nevertheless, since CP derive their data from the WIOT it should be possible to establish a connection between both data.  
Actually, we can do so. We just have to invert the explication above for obtaining CP's data from the WIOT. Therefore, to get values which are much more similar to the WIOT data, perform the following calculations at the example of the Australian food sector as destination sector.  

**Your task** here is to have a close look on the code and to check it afterwards.

```{r "1_3__4",signif.digits=5}
io_trade <- trade %>%
  select(Sector, Source_C, GO_Source, VA_Source) %>%
  distinct()

coeff <- inner_join(io, io_trade, by=c("Country"="Source_C", "Dest_S"="Sector") )

head(coeff,1)
```
If you already figured out what this code chunk did, you may directly jump to the next code chunk, which performs the calculation itself.  
Otherwise, here is an explanation of what happened: First, we select the columns of the data frame `trade` which we will need for the calculation. Then, because we need data from both the data frames `trade` and `io`, we join them with the function `inner_join()`. For more information on joining, see the following note.

#! start_note "Note: Joining data frames"
Joining two data frames means building a new data frame from two basis data frames.  
In general, the function checks whether there are columns in the two data frames which have the same name. If this is the case, these 'pivot' columns are merged into one and all remaining columns can be found in the new data frame. Moreover, all possible combinations of the column entries can be found, too. Consider the following exemplifying code chunk. **Your task**: Check it.  
```{r "1_3__5",optional=TRUE, points=0}
a <- data.frame(vehicle=c("Bike","Scooter","Scooter"), 
                main_colour=c("blue","black","white"))
a

b <- data.frame(vehicle=c("Scooter","Scooter","Bike"), 
                second_colour=c("orange","green","red"))
b

inner_join(a,b, by="vehicle")
```
You can observe that `inner_join()` matches the possible main and second colours of the `vehicle` (the pivot column) in the new data frame. Since the bikes have only one main and one second colour, there is only one combination of colours, thus one `bike` row in the joint data frame. For the scooter in contrast, there are two options for the main and the second colour each. Therefore there are four possible colour combinations and thus four entries of `scooter` in the joint data frame.


In our data frames `trade` and `io` we do not have columns with the same names. Nonetheless, with the command `by=c("Country"="Source_C", "Dest_S"="Sector")` we determine that the columns `Country` and `Source_C` are treated as if they had the same name. As a consequence the data frames can be joined as described above. The function is also told that `Dest_S` and `Sector` should be assumed to have the same name and to be another pivot column.  
#! end_note

<br> 

Having arranged the data the way we need it, **your task** is to perform the 'backward' calculation of the WIOT data itself.  
Multiply its I-O coefficients with its gross output and reduce this number by the value added within the sector. Remember that both the I-O coefficient and the value added are given in percent. A sector's material need then is one minus the value added within the sector.

```{r "1_3__6",signif.digits=5}
#coeff <- coeff %>%
#  filter(Country=="Australia", Dest_S=="Food") %>%
#  mutate(WIOT_backwards = ???/100 * ??? * (100- ??? )/100)

#head(coeff, 6)
```


In Figure 2, see a little extract of the WIOT in as comparison to the chunk's output. The extract is limited to the first few input sectors into the 'Food, Beverages and Tobacco' sector. Note that the sectors 'Textile and Textile Products' and 'Leather and Footwear' from the WIOT are aggregated into 'Textile' in CP.

![WIOT - The head of the 'Food' column](WIOT_AUS_Food.jpg)
 > Figure 2 - The head of the 'Food' column in the WIOT

 > *Source: World Input-Output Database (2016) - http://www.wiod.org/new_site/database/wiots.htm*

It is obvious that the intermediate consumption we calculate from the data CP provide is pretty similar in magnitude to the data the WIOT delivers. Still, there are significant differences. They may stem from several reasons, consider for example the following:
- CP perform a sector-wise aggregation of I-O coefficients in contrast to the WIOT calculation method (c.f. the discussion at the beginning of this exercise). This can increase the amount of materials that is (by default) considered to come from the home country. 
- The sources of gross output and value that CP use are different to the WIOT.
- Furthermore, CP integrate several WIOT into one set of I-O coefficients to smooth unique effects.

<br>

  
#### b) A Quick Quiz on the Input-Output Coefficients
It is **your task** to solve this quiz with the help of the following free code chunk. If you need help, press the `hint` button on top of the code chunk.
```{r "1_3__7",optional=TRUE, points=0}
# type in the code you judge necessary here
# do not forget to remove the hash keys '#'
```

#! addon__quiz__Input-Output Coefficients

 
#### c) More Examples of the I-O Table's Properties

A sector which has large material input shares - a high I-O coefficient - obviously is relatively important for other sectors. With the information we will see in Exercise 2.4 d) and through equation **(1)** in Exercise 2.3 b), we will also understand that higher I-O coefficients in general lead to a bigger weight of one sector's output prices in the calculation of another sector's costs.  
Now let us find out which four sectors on average have the highest material input contribution into production in general:  
**Your task:** Replace the question marks '???' by expressions which allow us to evaluate the average percentage that the single sectors contribute to material supply. In case you need help, press the `hint` button.
```{r "1_3__8",signif.digits=3}
# Substitute the ??? by the right variables
#??? %>%
#  group_by( ??? ) %>%
#  summarize(average=mean( ??? )) %>%
#  arrange(desc(average)) %>%
#  head(4)

```

From this data frame we can see which sectors contribute to all the sectors' outputs highly above average. `Other Business` hereby includes, for example, auditing, architectural, engineering and advertising activities. This holds according to International Standard Industrial Classification (ISIC) Revision 3, from the United Nations (2016). See the UN webpage for details: http://unstats.un.org/unsd/cr/registry/regcs.asp?Cl=2&Lg=1&Co=74.


**Your task** is now to get the sum of I-O coefficients over the destination sectors, while keeping the source sector which generally contributes most to value input, fixed. This works very similar to the third code chunk in part a, in which we calculated the 100%.
```{r "1_3__9"}
# Type or copy/paste the code similar to the one in part a) 

```

So this finding emphasizes what we found out in the chunk above. Namely, retail plays generally a very important role for overall prices and expenses, in particular in Australia.


<br>

Having finished this exercise, you now have a good overview of how sectoral linkages work. Furthermore you know how to employ the data frame `io`. Both of this will be important in the following of this RTutor problem set. 

<br>

<br>

## Exercise 2 - The Model



In the following of this exercise, some of the model's characteristics are presented, namely the Computable General Equilibrium, the Ricardian and the Gravity Equation properties. Also, you can find corresponding explanations why CP choose their model as they do. So if you are mainly interested in the data and the main findings, you can skip this exercise and continue directly with Exercise 2.1. However, scanning through the rest of this exercise might be interesting for you.
Exercises 2.1 to 2.5 will introduce a number of important parameters for CP's model, as well as formulas and model specifications. The equilibrium which CP solve is presented in Exercise 2.6.


<br> 

#### a) Computational (or Computable) General Equilibrium (CGE) Model

A **CGE** model is a tool used for answering how the economy would answer to external effects. Usually it uses data for sectors of whole economies, as well as some elasticity to be able to measure the effect of a deviation. One problem of CGE models is, that they tend to become extremely complex, intransparent and have key parameters chosen arbitrarily. Therefore sometimes they are called "black boxes" (Piermartini and Teh, 2005, and Baldwin and Venables, 1995).  
CP address this issue by building a relatively simple and comprehensible CGE model for which very few parameters (only the sectoral trade elasticities) need to be estimated. The data they employ are presented in Exercise 1. Key data for them are sectoral tariffs and trade elasticities.

Piermartini and Teh (2005) further state that the results of CGE simulations should only be considered as meaningful in indicating the order of magnitude of effects. Also, in general further efforts should be made in order to improve its specifications.

<br>

#### b) A Ricardian Model

As presented in Exercise 1, there are $N=31$ countries (denoted $i$ and $n$ in the formulas which will follow) and $J=40$ sectors (denoted $j$ and $k$ in the formulas that will follow), 20 of which are tradable and 20 of which are non-tradable.  
The sectors are linked, as every sector uses some of the infinitely many intermediate goods from all the other sectors and from the own sector. In addition to materials, only labour is an input for production. Producers and consumers may use (tradable) goods from all countries, because goods are homogeneous across countries. Tariffs must be imposed on imports, in particular because CP want to study effects of tariff changes. 
   
One of the characteristics of a **Ricardian** model - as we have it here - is that buyers search for the lowest price available for them, independent from the good's country of origin. Thus, a change in final consumption prices - either through a change in tariffs, in wages or in input prices - can have a notable effect on choosing the supplier. Through this channel, final consumption prices influence on allocation of demand and on trade flows. In particular, a Ricardian model is eligible to capture trade effects that arise from tariff reductions, which is one main purpose of CP's work. Consequently, choosing a Ricardian framework for their empirical study seems to be a reasonable choice that CP make.

Note that the infinite amount of different goods, with particular production efficiencies for each of them, leads to an untypical characteristic in classic Ricardian models: Every country is importer and exporter at the same time in each of the sectors. Since one country's productivity is different for every good, the country rather specializes on goods than on whole sectors. Consequently, every country imports an infinite set of goods, while it exports another set of infinitely many goods. This makes every country both an importer and an exporter in every tradable sector.  


See the info box below to learn something more about Ricardian models and an alternative model type when it comes to trade flow modelling, namely Armington models.

info("Ricardian and Armington models") # Run this line (Strg-Enter) to show info


<br>


To show what you have learnt in this exercise so far, **your task** is to answer the following questions on trade models.
#! addon__quiz__Trade models

<br>

So with a Ricardian model, an equilibrium for wages and prices regarding tariffs already can be found. 

<br>

#### c) Gravity Equations

Another feature of the model is that it is set up in a way that it takes the form of a **Gravity Equation**. This allows to easily estimate sectoral trade elasticities, which stand for the dispersion of production, a notion of comparative advantage. 

Gravity models are usually used to perform ex-post analyses employing historical data, which to some extent is also the case in CP, the publication we present here. See the info box below for a brief introduction into gravity equations.
info("Gravity Equations") # Run this line (Strg-Enter) to show info


<br>

According to Piermartini and Teh (2005), gravity models usually produce good empirical results. On the other hand, the variables and model specifications sometimes do not suffice economic theory requirements. Thus, one needs to be careful when interpreting the estimations' results.  
As a result, it is important for EK and for CP that EK derive a gravity-type equation from their Ricardian model setting. Therefore, the theoretical link between the gravity equation and the Ricardian model - which has an established foundation in economic theory - makes a meaningful interpretation of the variables and results of the gravity model easier. See the info box "Expenditure shares, Ricardo and gravity" in Exercise 2.5 b) for more information on EK's derivation of a gravity-type equation from their Ricardian model set-up.


<br>


**Your task:** finish this exercise and demonstrate what you have learned in this last part by answering the quiz on gravity equations.
#! addon__quiz__Questions on Gravity Equations


info("Other innovations of CP") # Run this line (Strg-Enter) to show info

Now you have a good overview over the main characteristics CP give their model. In the following exercises you will get more practical insights into the model.

<br>



## Exercise 2.1 -- Model Specifications (Efficiency of Production)

In this exercise, you will get to know details about the important features of the production efficiency's randomness. 

Productivity $z^j_n(\omega^j)$ is governed by country- and sector-specific random variables. In particular, the **efficiency of producing** one single good $\omega^j$ out of the sector $j$ is in every single country $n$ the realisation of a **Frechet distribution** with parameters $\theta^j \geq 0$ and $\lambda^j_n \geq 0$. The distributions of productivities are assumed to be independent across all countries, sectors and goods. 

In other words, the productivity of each good $\omega^j$ out of the continuum of goods is drawn independently from each of the draws of the following three parameters: Other goods in the same country, the same good produced in different countries and other goods from the same sector.  

More on the parameters $\theta^j$ and $\lambda^j_n$ will be presented in parts a) and b) respectively.


<br>

For a little more information on the Frechet distribution see the corresponding info box below.

info("Frechet distribution") # Run this line (Strg-Enter) to show info

<br>

#### a) $\theta ^j$ - Theta in the Frechet Distribution and in the Model

In CP's model, the Frechet distribution sector-specific shape parameters $\theta^j$ - the Thetas - represent the concentration of productivity. These are the trade elasticities `Trade_Elast` in the data frame `trade`. They are key parameters to the model of CP as they quantify the degree of comparative advantage within one sector $j$. Trade elasticities $\theta^j$ cannot be calculated directly from available data, in Exercise 5.1 we will see how to estimate them and what impact they have on trade.

To see why the Thetas are a notion of comparative advantage and why CP call them trade elasticities, first consider the probability density function (also called PDF) of a Frechet distribution with parameters $\theta^j$ and $\lambda^j_n$:

$$\lambda^j_n \theta^j x^{-1-\theta^j} \exp \left[ -\lambda^j_n x^{-\theta^j}  \right].$$

Second, note that the functions `print_frechet_5()` and `print_frechet_12()` implement the PDFs of two Frechet distributions. Both have the scale parameter $\lambda^j_n$ fixed to $0.6$, a realistic value within CP's and EK's model settings. The shape parameter $\theta^j$ has different values in each function, namely $5$ and $12$. These values, too, are realistic in the context of the model we discuss here. These values are also where the appendices `_5` and `_12` in the function names come from. To see exemplarily how the code of the function `print_frechet_5()` looks like, **your task** is to check the following chunk. 
```{r "2_1",points=0}
print_frechet_5
```
You see, this is a simple implementation of the formula for the PDF.

In order to visualize how the two PDFs' characteristics differ, **your task** is to execute the following chunk in which the plot with both densities is created.
```{r "2_1__2",points=0}
ggplot() + 
  stat_function(aes(x = 0:3), fun = print_frechet_5, n = 301, col="blue") + 
  stat_function(aes(x = 0:3), fun = print_frechet_12, n = 301, col="red") +
  xlab("x-value") +
  ylab("PDF")
```
As you can easily see in the code, the red line represents the PDF of a Frechet distribution with parameters $\lambda=0.6$ and $\theta^j=12$. The blue line stands for the PDF with $\theta^j=5$. So, as the lines represent possible production efficiencies' distributions in CP's model, from this plot follows clearly that a higher $\theta^j$ leads to a higher concentration of production efficiencies. This in turn makes plausible that the production costs and the price of a single producer tends to be closer to the other producers' prices. Consequently, a higher $\theta^j$ makes is more probable that a price change of one producer leads to a reallocation of demand. This is what is intuitively meant by the term **trade elasticity**.

<br>

#### b) $\lambda^j_n$ in the Frechet Distribution

   
The sector- and country-specific location parameter $\lambda^j_n$ determines the average productivity in a sector. This is a notion of absolute advantage. A higher $\lambda^j_n$ basically shifts the PDF to the right, raising the probability of a high production efficiency in sector $j$ in country $n$. 

As we will see later, the parameters $\lambda^j_n$ need not be estimated in CP's model. Therefore we will neither do this in the course of this RTutor problem set. If you want to see some sensibly estimated values of $\lambda^j_n$, see the optional Exercise 2.2. That exercise is also recommended to you if you are interested in more information on the Frechet distribution in the context of our model.   

Note that, because of the notion of comparative advantage through differences in technology/productivity, this model has **Ricardian** characteristics. 

<br>

Now it is **your task** to answer the following questions, where 'lambda' stands for $\lambda^j_n$ and 'theta' stands for $\theta^j$.

#! addon__quiz__Theta and Lambda

<br>

This exercise gave you the most important information on production efficiency. If you would like to get even more insights, see Exercise 2.2.


## Exercise 2.2 -- The Frechet Distribution in EK

This exercise is only designed for whom is interested in more details of the distribution of production efficiencies and how they affect trade. If you only want to grasp the most important points of the article, you can skip this exercise.

#! start_note "Note: The Frechet distribution and its parameters in EK"
EK assume that the efficiency of country $i$ in producing each good $j$ is drawn independently from a random variable $Z_i$, where 
$$F_i(z)=\mathbb{P}_i(Z_i \leq z) = exp(-T_i z^{-\theta}),$$
thus $Z_i$ follows a **Frechet distribution**.  
Comparing this representation to the formula presented in the info box "Frechet distribution" above, you can see that EK and CP use very similar formulas. The differences stem from only two points: First, CP consider country-sector specific distributions of productivity, whereas EK assume the distributions only to be country-specific. Second, EK's country specific parameter $T_i$ is replaced by country-sector specific $\lambda^j_n$ in CP. Therefore, we can take the values EK estimate for $T_i$ and $\theta$ as proxies for CP's parameters $\lambda^j_n$ and $\theta^j$. Note that the $\theta^j$ actually will be estimated within this RTutor problem set in Exercise "Trade Elasticities", so this note rather works with EK's results and that way illustrates CP's model which builds on EK.

With three different approaches, EK estimate three different values for $\theta$: 3.60, 8.28 and 12.86, with 8.28 being their preferred value.  
Whereas country-specific $T_i$ are only given normalized in comparison to the US value (Table VI, p. 1765 EK), it is possible to calculate their explicit values with the help of several equations and tables. For example, in the cases of Portugal, Japan and the US, the respective values of the $T_i$ are 0.028, 0.58 and 0.65. 

**Your task** now is to check the following code chunk, in order to plot the approximate cumulative distribution functions of the production efficiencies in Portugal, Japan and the US, where $\theta=8.28$ and the $T_i$ as stated above. The plot's range on the x-axis is limited to $a=0$ at the left and to $b=2.5$ at the right.
```{r "2_2",points=0, optional=TRUE}
print_frechet2(a=0, b=2.5)
```

Now it is **your task** to solve the quiz. You may want to use the following free code chunk in order to zoom into the plot we created above or to perform calculations. Another way to solve some of the quiz questions is to use the function `uniroot()`. You can find a short description of this function in the corresponding info box 'The function uniroot()' below.
```{r "2_2__2",points=0, optional=TRUE}
# You may freely use this code chunk to solve the quiz.
```


#! addon__quiz__Frechet distribution of Production Technologies/Efficiencies


<br>

Recall that in part c) we introduced the unit price of the tradable intermediate good $\omega^j$ produced in country $i$ available in country $n$ by
$$\frac{c^j_i \kappa^j_{ni}} {z^j_i(\omega^j)}.$$
Since EK do not consider sector specific production efficiencies and since they employ $d_{ni}$ instead of $\kappa^j_{ni}$ let us reduce this formula to
$$\frac{c_i d_{ni}} {Z_i(\omega)}.$$

info("The function uniroot()") # Run this line (Strg-Enter) to show info

Let us now consider concrete efficiencies of producing a certain good $\omega$. Assume that both Portugal (country P) and Japan (country J) draw their respective median value of the Frechet distribution, i.e. $Z_P(\omega)= 0.68$ and $Z_J(\omega)= 0.98$. Additionally, we have from EK that $d_{PJ}=2.56$ for imports to Portugal from source country Japan and $d_{JP}=3.25$ the other way round.   
To calculate prices of goods from one country in another country there are only input costs missing. They consist of the cost of intermediate inputs and the cost of labour. Since the material input costs depend on prices again, there has to be found a global equilibrium. In order to keep this example simple we only consider labour costs, approximated by the worker quality adjusted labour compensation, which equal $w_P=0.23$ and $w_J=0.78$, respectively.

Hence, the prices of good $\omega$ in Portugal, produced in Portugal and in Japan respectively, are calculated as follows:  $\frac{w_P \cdot d_{PP}}{Z_P(\omega)}$ and $\frac{w_J \cdot d_{PJ}}{Z_J(\omega)}$.  

**Your task** is to simply check this code chunk.
```{r "2_2__3",points=0, optional=TRUE}
# the price for the Portuguese product:
(0.23*1) / 0.68
# the price for the Japanese product:
(0.78*2.56) /0.98
```
Now **your task** is to perform the same calculations for the Japanese market, that is, prices of goods in Japan.
```{r "2_2__4",points=0, optional=TRUE}
# the price for the Portuguese product:
(0.23*3.25) / 0.68
# the price for the Japanese product:
(0.78*1) /0.98
```
As we can see, in each of the two cases the domestically produced good is cheaper than the imported one. This is not surprising because the trade costs $d_{ni}$ between Portugal and Japan are indeed very high as we saw above. Nevertheless, production efficiency being a random variable, for some goods it occurs that the import may be cheaper. 


Using the function `uniroot()` in a next step we can calculate directly the Portuguese efficiency at the 90th percentile. We therefore define the function `exp( -T * x^(-\omega) ) - desired level`. In this case we have `exp( -0.028 * x^-8.28 ) - 0.9` with $T_P=0.028$ and `omega=`$\omega=8.28$. Finally with this function we find out where the cumulative distribution function of Portuguese reaches the 0.9 level. **Your task** is to check this code chunk and have a close look at it.
```{r "2_2__5",points=0, optional=TRUE}
uniroot(f = function (x) exp(-0.028*x^-8.28) - 0.9, interval= c(0,2))$root
```
As we can see, for this Portuguese product $\omega_2$ the efficiency of production $Z_P(\omega_2)$ rose from 0.68 to 0.85.
**Your task** is to calculate Japanese efficiency at the 10th percentile. Remember that for Japan $T_J=0.58$.
```{r "2_2__6",points=0, optional=TRUE}
# replace the '???' by the right function
#uniroot(f = function (x) ??? , interval= c(0,2))$root

```

Now we can calculate the respective prices of good $\omega_2$ in Japan, produced in Portugal and Japan respectively. **Your task** is to perform the calculation, using what you learned in the last code chunks and using the production efficiency you calculated in the last chunk. Round the values to two positions after decimal point.

```{r "2_2__7",points=0, optional=TRUE}
# the price for the Portuguese product:
# ???
# the price for the Japanese product:
# ???
```
As a result, in this case the Portuguese product is cheaper than the Japanese product. This means that in EK's model international trade is possible even between countries that are far away. Still, this is not very likely, as simultaneously Portugal needs a very high (\~ the highest 10%) and Japan a very low (\~the lowest 10%) production efficiency for product $\omega_2$ in order to facilitate trade. So only for a little more than 1% of products importing them from Portugal to Japan is attractive due to a price criterion.

#! end_note


<br>



## Exercise 2.3 -- Model Specifications (Households, Intermediate Goods, Costs and Prices)
In this exercise, you get to know some of the main relationships in CP's model.

#### a) Households
- In each country, the households maximize utility by consuming final goods according to country-specific preferences.
- Households get *income* $I_n$ from labour (*labour* $L_n$ at *wage* $\mathsf{w}_n$), from transfers from the rest of the world and from tariffs. So tariffs directly benefit the countries' households.

#### b) Intermediate Goods and its Costs

- In each sector $j$, there is produced a *continuum of intermediate goods* $\omega^j \in [0,1]$.
- To produce $\omega^j$, labour and materials from all sectors are employed. The need for each factor of production is specified by the *input bundles*. Their respective compositions are country-sector specific, independent from the good $\omega^j$ and from production efficiency.
- The cost of an input bundle is $c^j_n$.  
- The *efficiency of producing* $\omega^j$ is denoted by $z^j_n(\omega^j)$. You learned more on this topic in Exercises 2.1 and optionally in Exercise 2.2.  
- Firms sell at unit cost $\frac{c^j_n}{z^j_n(\omega^j)}$, which means that CP assume perfect competition and constant returns to scale.

The cost of an input bundle is given by
$$\tag{1} c^j_n = A^j_n \mathsf{w}^{\gamma^j_n}_n \cdot \prod^J_{k=1} {P^k_n}^{\gamma^{k,j}_n},$$

where $P^k_n$ is the *unit price of the composite intermediate good* from sector $k$, a constructed sectoral price index consisting of the prices of all sector $k$ goods $\omega^k$, see the note in part d). The parameter $A^j_n$ is a constant. $\gamma^{kj}_n$ represents the *share of the intermediate consumption* and $\gamma^j_n$ is the *share of value added* during the production. You will learn more on these two important parameters in Exercise 2.4. Do not confuse $\gamma^{kj}_n$ and $\gamma^{jk}_n$, where the direction of material flow is opposite.


> Through equation **(1)** we can see the interrelation between all the sectors. A change in one sector's material price directly affects the cost of the other sectors' input bundles.

<br> 

CP also work with production technology in their model. See the following info box for some more information on this.
info("The basic concept of production technology") # Run this line (Strg-Enter) to show info

<br>
Now, **your task** is to solve the following quiz in order to recapitulate the first findings in this exercise.
#! addon__quiz__2.3 a)-b)
<br>

#### c) International Trade Costs

Both final consumption products and intermediate goods $\omega^j$ are supplied at minimum cost. Also, they are purchased at lowest price across all countries, as a key characteristic of the **Ricardian** model. This allows buyers to choose supplier at lower cost subsequent to price changes, in particular after tariff reductions. This is a key feature why the model suits well the main purpose of CP's work. 


Until now, we only know that tariffs play an important role in CP's work, we do not yet know how. In the following we will see how they enter properly into the model.  
Naturally, tariffs influence on prices. So what are the final prices that households or companies in country $n$ pay for a sector $j$ good? Apart from the costs that occur during the production process according to the value chain, there are also two types of trade costs: Tariffs $\tau^j_{ni}$ on goods imported to country $n$ from country $i$ and iceberg costs $d^j_{ni}$. Iceberg costs mean that one unit of a good from tradable sector $j$ imported to country $n$ from country $i$ requires the production of $d^j_{ni} \geq 1$ units of that good, where $d^j_{nn}=1$. Setting $\tilde{\tau}^j_{ni}:=(1+\tau^j_{ni})$, we have total trade costs 
$$\kappa^j_{ni}=\tilde{\tau}^j_{ni} d^j_{ni}.$$  
Note that $\kappa^k_{nn} \equiv 1$ for all sectors $k$ and $\kappa^j_{ni}= \infty$ for all non-tradable sectors $j$ with $n \neq i$.   
In their work, CP neither calculate $d^j_{ni}$ nor $\kappa^j_{ni}$ explicitly, as we will see later. So if you want to get a notion of some characteristics and values of these variables, see the note box below.

#! start_note "Note: Trade costs in EK"
In EK, their variable $d_{ni}$ represents geographic barriers. If there was a zero-gravity world, there would be no geographic barriers and thus $d_{ni} \equiv 1, \forall n,i$. Contrarily, if there was autarky and prohibitive barriers between countries, $d_{ni}= \infty, \forall n,i$.
Parameters that EK identify to have an effect on $d_{ni}$ are e.g. a shared border, a common language, distance and also tariffs. Consequently, their $d_{ni}$ rather is equivalent to $\kappa^j_{ni}$ in CP which also includes the tariff parameter $\tau^j_{ni}$. EK work with data from 1990, so the estimated values for $d_{ni}$ should still fit fairly well to the data from 1993 that CP provide.  
Note that in the European Union, there were no tariffs in 1990, so $\tau^j_{ni}$ is not involved. That means that the estimates for $d_{ni}$ of EK correspond well to $d^j_{ni}$ and thus to $\kappa^j_{ni}$ in CP.

See EK's table II (p. 1754 EK) for examples of their estimates of relative price indices. Exemplarily, the price index of Belgian imports from Germany is 1.25 times the price index of the cheapest source when the goods from all countries are available. This means that a Belgian buyer who only buys German goods would have a 25% higher price index than if he bought the cheapest goods available in Belgium. Actually this is the lowest price penalty within the European Union that EK explicitly state. The highest penalty within the EU exists on Danish imports from Portugal, where the price index is 2.21, still with no tariffs included.

For the set of 19 OECD countries, the highest index EK that estimate is 3.25, for Japan importing from Portugal. Note that these indices are not symmetric, as for example the index for Portugal importing from Japan is 2.56. Tariffs are included therein. To evaluate this index in a more suitable way, we want to find an approximate value for the tariffs imposed in a year close to 1990 with our data.  

First, **your task** is to read in the needed data.
```{r "2_3"}
trade <- read.csv("trade.csv")
io <- read.csv("io.csv")
```


Then, **your task** is to calculate the average percentage of tariffs that Japan imposed on imports from Portugal in 1993 on tradable sectors. Use the given code for this task.
```{r "2_3__2",optional=TRUE, points=0, signif.digits=3}
#trade %>%
#  filter( ??? ,Tradable==1) %>%
#summarize(average_tariff_1993= ??? ) 

```

As we can see, the average tariff of 2.5% does not explain at all the height of the index for this pair of countries. Not even the maximum of tariffs can, being 16.8% there. Hence, EK find out that on the one hand distance raises trade (or iceberg) costs. On the other hand a common border, common language or a common membership in a free trade area lower trade (or iceberg) costs. These costs correspond to $d^j_{ni}$ in CP and thus affect directly $\kappa^j_{ni}$. 

#! end_note

<br>


#### d) Prices

The unit price of the tradable intermediate good $\omega^j$ produced in country $i$ available in country $n$ is given by
$$\frac{c^j_i \kappa^j_{ni}} {z^j_i(\omega^j)}.$$ 
Consequently, the price paid in country $n$ for $\omega^j$ is the minimum price available in that country:
$$p^j_n(\omega^j)=\min_i \left\{ \frac{c^j_i \kappa^j_{ni}}{z^j_i(\omega^j)}\right\}.$$

For non-tradable goods $\omega^j$, we have $p^j_n(\omega^j)=\frac{c^j_n}{z^j_n(\omega^j)}$ .

Note that $P^k_n$ is the unit price of the composite intermediate good, whereas $p^j_n(\omega^j)$ is only the price of one intermediate good $\omega^j$ out of the continuum of intermediate goods. The relation of $P^k_n$ and $p^j_n(\omega^j)$ is presented in the following info box.

info("The relation between the price of the composite intermediate good and the prices of the intermediate goods") # Run this line (Strg-Enter) to show info

It is important to mention that composite intermediate goods are used in two ways: As materials for producing other intermediate goods and also directly as final consumption goods.

<br>


Subsequently, knowing the characteristics of the production technologies, trade costs and costs, CP solve for the country- and sector-specific **price of composite intermediate goods**. 

$$\tag{2} P^j_n = \Upsilon^j \left[ \sum^N_{i=1} \lambda^j_i (c^j_i \kappa^j_{ni})^{-\theta^j} \right]^{-\frac{1}{\theta^j}},$$

where $\Upsilon^j$ is a constant. CP show a detailed derivation of equation **(2)** in their Appendix. Note that for the case of non-tradable goods, this equation reduces to 
$$P^j_n = \Upsilon^j  (\lambda^j_n)^{-\frac{1}{\theta^j}} c^j_n$$ 
due to the properties of $\kappa^j_{ni}$.


> Through equation **(2)** we can see the interrelation between all the countries. At least for the tradable sectors, all countries' input bundle costs have a direct non-zero influence on the price of composite intermediate goods in all countries. Together with equation **(1)**, it is clear that all sectors, tradable or not, in all countries are linked with each other, at least indirectly.

For more details on how to obtain equation **(2)**, please refer directly to CP.

<br>

Now, **your task** is to solve the following quiz on prices and intermediate goods to recapitulate these topics.
#! addon__quiz__2.3 c) -d)

<br>

With the information provided in this exercise, some of the important linkages in the model can already be conceptualized.


## Exercise 2.4 -- Other Necessary Parameters and Formulae


The definition of the equilibrium, that is aimed to be solved in this model, shows that for the whole model we only need a few parameters. We will introduce the 'equilibrium in relative changes' in Exercise 2.6. The parameters we need can be calculated easily by employing the data frames `trade` and `io` from Exercises 1 to 1.3.

In this exercise, you will see which parameters are still needed and how you can obtain them from the provided data.

<br>


#### a) Tariffs
Old and new tariffs $\tau_{ni}$ and $\tau^\prime_{ni}$ on imports by country $n$ from country $i$ are given separately for all the sectors in `Tariffs1993` and `Tariffs2005`. In general, the first subscript stands for the importing country (here $n$), whereas the second subscript indicates the exporting country (here $i$). 

<br>


#### b) Expenditure Shares 
Bilateral trade shares (or expenditure shares) $\pi^j_{ni}$ stand for the proportion of country $n$'s spending on sector $j$ goods originating from country $i$. The positions of the super- and subscripts in this problem set have generally the same significations.  

Expenditure shares can be calculated using bilateral trade flows $M^j_{ni}$ in the column `Trade_Vol` and tariffs $\tau$ as follows:  
First calculate expenditures as $X^j_{ni}=M^j_{ni}(1+\tau^j_{ni})$. That means we add the imposed tariffs to the original value of trade flows, which is what we actually pay on an imported good or service.
Then, bilateral trade shares are obtained by $\pi^j_{ni}=\frac{X^j_{ni}}{\sum^N_{h=1}X^j_{nh}}$.   
Note that from this equation follows directly $\sum^N_{i=1} \pi^j_{ni} =1.$

<br>

In Exercise 2.5 b) we will see how $\pi^j_{ni}$ fits into the model conceptually and how it is linked to the other parameters.

<br>

To present an easy example of calculation in this exercise, the data frame `temp_2.4.b` is prepared. As a first step, it is **your task** to read it in.
```{r "2_4"}
temp_2.4.b <- read.csv("temp_24b.csv")
```

Have a quick look on `temp_2.4.b` in the following info box.

info("The data frame `temp_2.4.b` for the following calculation") # Run this line (Strg-Enter) to show info

  


Now perform the calculation of the expenditures $X^j_{ni}$ and the expenditure shares $\pi^j_{ni}$ for $j=\mathsf{Wood}$, $n=\mathsf{Indonesia}$ and all the 31 different $i$. **Your task** is to fill in the correct code replacing the question marks `???` and to remove the `#`. If you need help, press the `hint` button.

```{r "2_4__2",signif.digits=3}
#temp_2.4.b <- temp_2.4.b %>%
#  mutate(Expenditure = ??? )  %>%
#  mutate(Exp_Shares = 100* ???/sum( ??? ) )
#temp_2.4.b
```

<br>


Note that the result - that only one fifth of total sales in Indonesia stem from Indonesian production - appears to be very low. This impression is evoked especially because Indonesia is one of the 15 largest countries in the world and is covered widely by tropical forest. Maybe not all of the realized domestic sales are captured by (or declared to) the official entities and the statistics creating institution. This might be the case for more countries in the sample, possibly resulting in a biased outcome of the whole analysis CP perform.


<br>

#### c) Value Added and Share of Value Added
The share of value added in production $\gamma^j_n$ is given directly by `VA_Source`.   
Then, the value added $w_nL_n$ is the product of the share of value added (`VA_Source`) and gross production (`GO_Source`).

The share of value added $\gamma^j_n$ and the share of intermediate consumption, see part d), are both employed in equation **(1)** in Exercise 2.3 b).

<br>

#### d) The Share of Intermediate Consumption
$\gamma^{jk}_n$ is the share of country $n$'s sector $k$'s total value of output that stems from sector $j$'s material input. It is also called the share of intermediate consumption. The $\gamma^{jk}_n$ are obtained as follows:  

Divide the input of sector $j$ into sector $k$ by the sum of the inputs of all sectors into sector $k$. This is already what CP give in their data, it is the column `IO_Coeff` in our data frame `io`. Compare that, in Exercise 1.3.c), we calculated the sum over I-O coefficients with fixed destination sectors. We found that the sum is always 100 percent, which means that the I-O coefficients only give the contribution of sectors to material input.   
Since we are aiming at the contribution of sectors to the output value, consider $\gamma^k_n$, the share of value that is added within sector $k$. To do so, multiply the I-O coefficients with (1-$\gamma^k_n$) in order to normalize input shares and find the $\gamma^{jk}_n$. 

Consequently, we know that the percentage of a product's value that is added within a sector equals one hundred minus the input from all sectors. This gives the identity:
$$\gamma^k_n := 1 - \sum^J_{j=1} \gamma^{jk}_n.$$ 

Throughout this problem set, pay attention to whether $\gamma^{jk}$ or $\gamma^{kj}$ is used. Due to a coherent superscript usage on the left-hand sides of central equations in this model, both $\gamma^{jk}$ and $\gamma^{kj}$ are used from time to time, see equations **(1)** and **(4)** as examples. 

<br>

If you are interested in performing an exemplarily calculation of $\gamma^{kj}_n$, see the following note. Otherwise, continue with the quiz which closes part d)

#! start_note "Note: An exemplarily calculation of the intermediate consumption share"

The calculation example concerns the case of the automotive sector `Auto` in Mexico. Hence we have $j=Auto$ and $n=Mexico$. First, the part of the data frame `io` which we need should be chosen and stored in `inputs`. Second, we want to have a single number saved in `val_add` which gives the percentage of value added $\gamma^j_n$.    


**Your task:** first, read in the needed data.
```{r "2_4__3"}
trade <- read.csv("trade.csv")
io <- read.csv("io.csv")
```

Performing these calculations is **your task**. Note that the Input-Output coefficients and the values added are all given in percent and that you can always press the `hint` button if you need some help.
```{r "2_4__4"}
#inputs <- ??? (io, ??? )
#  # Dest_C is arbitrary
#val_add <- ??? (trade ,Dest_C=="UK", Source_C== ???, ??? )$VA_Source  

```

If you want, you can use the following free code chunk to have a look how the two variables you created look like.
```{r "2_4__5"}
# Enter code freely here if you want to
```

<br>

In the column `IO_Coeff` in `inputs` we now have stored the percentages that every sector provides to the materials need of the Mexican automotive sector. What we are trying to calculate in a next step is the variable $\gamma^{kj}_n$, the percentage that every sector provides to the **total output value**. Therefore, the values in `IO_Coeff` need to be multiplied with the part of total output that stems from material input. Remember that `val_add` stores the `VA_Source` values $\gamma^j_n$, namely the percentage of value added within the sector. Since we would like to calculate the value contributed by materials instead, it is **your task** to perform the remaining calculation step to obtain the $\gamma^{kj}_n$ for $j=Auto$ and $n=Mexico$.   

```{r "2_4__6"}
#gamma_kj_n <- mutate(inputs, Gamma_kj_n= ??? /100 * (100- ??? )) # gamma_kj_n in %
#gamma_kj_n
  ## the sum of input costs equals one minus the share of value added within the sector
#sum(gamma_kj_n$Gamma_kj_n)
#(100-val_add)
```

As a result, we can see which percentage of the value output of the automotive sector in Mexico stems from the material inputs from the different sectors. Let us have a look into row 18, where the contribution of the automotive sector into itself is stated and continue with the text outside this note. 

#! end_note

<br>

The calculations of $\gamma^{kj}_n$ inside the note show that $\gamma^{kk}_n$ for $k=\mathsf{Auto}$ is only 0.4%, which means that the self-contribution of the automotive sector is pretty small. Despite this low share might appear surprising at first view, this number makes sense. It tells us only, which part of the final value of sold automotive products stems from other products from the automotive sector that were sold before. Examples might be company cars for the management.
Actually, the biggest part of the value of cars et cetera is indeed added within the automotive sector, even though material inputs are not the reason for that. Instead, the work that the staff performs in the production process stands for 27% of the total value of output. This is what the variable $\gamma^j_n$ expresses. We can see this by the last two outputs of the chunk, `sum(gamma_kj_n$Gamma_kj_n)` and `(100-val_add)`. Naturally, both calculations give the same share of value added within the sector.

The biggest part of the value added from outside the automotive sector is in retail. Compare the similar finding at the end of Exercise 1.3 c), keeping in mind that the I-O coefficient is an important parameter for the determination of $\gamma^{kj}_n$. Furthermore, it is not surprising thinking about the big car dealing centres in every city which obviously are an important part of the value chain. Basic metals and plastic inputs follow in importance, which also instinctively makes sense.


<br>
To give you the opportunity to demonstrate what you have just learned, **your task** is to solve the following quiz.

#! addon__quiz__Needed Parameters

Now you have a good overview of the concept of intermediate consumption, which is important for CP's model.

<br>


#### e) Final Consumption Share 
Another interesting aspect in the model is the **final consumption share**.  
Final consumption on sector $j$ goods, which is consumption of the households, equals total expenditure on sector $j$ goods minus the intermediate goods expenditure. Additionally, as we will see in Exercise 2.5 b), households spend all their income $I_n$. 

So as a result the final consumption share $\alpha^j_n$ is given by
$$\alpha^j_n = \frac{Y^j_n + D^j_n - \sum^J_{k=1} \gamma^{jk}_n Y^k_n}{I_n},$$
where trade deficits in sector $j$ in country $n$ are given by 
$$D^j_n=\sum^N_{i=1} \left ( M^j_{ni}-M^j_{in} \right ).$$

<br>

Now, it is **your task** to show what you have learned in the last part of this exercise.

#! addon__quiz__Alphas

Having completed this exercise, you now have a good notion of how CP calculate many important model parameters from the available data.

<br>



## Exercise 2.5 -- Model Specifications (Expenditure and Expenditure Shares)

In Exercise 2.4 b) we already showed how to calculate expenditure $X^j_{ni}$ and expenditure shares $\pi^j_{ni}$ from the data CP provide. Now we are going to embed these variables into the model. 

#### a) Expenditure
 
The **expenditure** in country $n$ on sector $j$ goods from country $i$ is denoted $X^j_{ni}$. With the variables for costs and production technology introduced in Exercise 2.3 b), note that we have 
$$X^j_{ni} = \mathbb{P} \left[ \frac{c^j_i \kappa^j_{ni} }{z^j_i (\omega^j)} \leq \displaystyle\min_{h \neq i} \frac{c^j_n \kappa^j_{nh}}{z^j_h (\omega^j)} \right]   X^j_n,$$
with unit cost $\frac{c^j_n}{z^j_n(\omega^j)}$.  
**Total expenditure** in country $n$ on sector $j$ goods is denoted $X^j_n = \sum^N_{i=1} X^j_{ni}$.

#### b) Expenditure Shares

Thus, in sector $j$, the **share of expenditure** in country $n$ on goods from country $i$ is given by 
$$\pi^j_{ni}= \frac{X^j_{ni}}{X^j_n}= \frac{X^j_{ni}}{\sum_h X^j_{nh}}.$$ 
Employing the Frechet distribution and substituting $X^j_{ni}$ and $X^j_n$, CP reformulate this ratio also as 
$$\tag{3} \pi^j_{ni} = \frac{\lambda^j_i \left[ c^j_i \kappa^j_{ni} \right]^{-\theta^j}}{\sum^N_{h=1} \lambda^j_h \left[ c^j_h \kappa^j_{nh} \right]^{-\theta^j}}.$$
Hence, the expenditure shares only depend on trade costs $\kappa^j_{ni}$, input prices $c^j_n$ and the parameters of production efficiency or technology $\lambda^j_n$ and $\theta^j$. Therefore changes in tariffs directly affect the expenditure shares via trade costs $\kappa^j_n$.  
Note again that from equation **(3)** follows directly $\sum^N_{i=1} \pi^j_{ni} =1.$

info("Expenditure shares, Ricardo and gravity") # Run this line (Strg-Enter) to show info
<br>


Now it is time to apply what you have learned so far in this exercise, so it is **your task** to solve the following quiz. You may use the free code chunk after reading in the data.
```{r "2_5",optional=TRUE}
temp_2.4.b <- read.csv("temp_24b.csv")
```

This code chunk is for optional use.
```{r "2_5__2",optional=TRUE}
# Enter your code here
# do not forget to remove the hash keys `#`
```

#! addon__quiz__Expenditure and Expenditure Shares

<br>

For an example of the calculation of expenditure and expenditure shares see Exercise 2.4 b). 

<br>


#### c) Total Expenditure and Trade Balance

Another feature in CP's model is **income**. The total income of country $n$'s households $I_n$ is defined as the sum of labour income $\mathsf{w}_n L_n$, trade deficit $D_n$ and tariff revenues $R_n$, thus $$I_n=\mathsf{w}_n L_n + D_n+ R_n.$$  
For whom this definition seems confusing, see the following info box.

info("The households' income in CP") # Run this line (Strg-Enter) to show info


Tariff revenues are 
$$R_n=\sum^N_{i=1} \sum^J_{j=1} \tau^j_{ni} M^j_{ni},$$ 
with the sector $j$ imports to country $n$ from $i$ being the expenditures without tariffs: 
$$M^j_{ni}= \frac{X^j_{ni}}{\tilde{\tau}^j_{ni}}=X^j_n \frac{\pi^j_{ni}}{\tilde{\tau}^j_{ni}}.$$

Similarly, the sector $j$ exports from country $n$ to $i$ are defined: $E^j_{ni}=X^j_i \frac{\pi^j_{in}}{\tilde{\tau}^j_{in}}$.  
Remember that $\tilde{\tau}^j_{ni}= (1+\tau^j_{ni})$.  
Sectoral trade deficits thus are given by 
$$D^j_n =\sum^N_{i=1} M^j_{ni}-E^j_{ni}$$ 
whereat countrywide trade deficits $D_n$ simply equal the sum of all sectoral deficits.

  
Employing $\gamma^{jk}_n$, the share of intermediate consumption (see Exercise 2.4 d)), we get the following result for expenditures.  
For the reason that $\sum^N_{i=1} E^k_{ni}$ is the total output of country $n$'s sector $k$, $\sum^J_{k=1}\gamma^{j,k}_n \sum^N_{i=1} E^k_{ni}$ is the total material need from sector $j$ for the total production in country $n$. Summarizing the firms' expenditure on materials and the households' expenditure in a sector, we get the total expenditure on goods from sector $j$, representable as: 
$$\tag{4} X^j_n= \sum^J_{k=1}\gamma^{j,k}_n \sum^N_{i=1} E^k_{ni} +\alpha^j_n I_n= \sum^J_{k=1}\gamma^{j,k}_n \sum^N_{i=1} X^k_i \frac{\pi^k_{in}}{\tilde{\tau}^k_{in}} + \alpha^j_nI_n.$$
The right-hand side of the equation results from the above representation of $E^k_{ni}$.  
Note that in country $n$, $\alpha^j_n$ is the share of the households' income they spend on goods from sector $j$, with $\sum^J_{j=1} \alpha^j_n =1$. Together with the fact that $\alpha^j_nI_n$ in equation **(4)** stands for households' expenditure, this implies that households spend all their income.

Using the formula for trade deficits $D^j_n$ above we can obtain the equation

$$\tag{5} \sum^J_{j=1} \sum^N_{i=1} \frac{X^j_{ni}}{\tilde{\tau}^j_{ni}}-D_n = \sum^J_{j=1} \sum^N_{i=1} \frac{X^j_{in}}{\tilde{\tau}^j_{in}}.$$

This equation reflects the trade balance, as for country $n$ the sum of all its exports equals the sum of all its imports minus the trade deficit. As we will see in Exercise 2.6, equation **(5)** together with equations **(1)-(4)** must be fulfilled for the model's central equilibria.

<br>




<br>

#### d) Additional Interpretations
Equation **(5)** visualizes that total expenditure in country $n$ (without tariffs) minus its trade deficit equals the sum of all countries' total expenditure on goods produced in country $n$ (without tariffs).

Furthermore, if we calculate the sum of expenditures across sectors (i.e. if we add equation **(4)** across sectors) and substitute into equation **(5)** we get
$$\tag{5'} \mathsf{w}_nL_n = \sum^J_{j=1} \gamma^j_n \sum^N_{i=1} \frac{X^j_{in}}{\tilde{\tau}^j_{in}}.$$
That means that in country $n$, income from all available labour ($L_n$) equals the value added within each sector due to the global total demand for products from $n$, net of tariffs. Consequently, as there are no other sources of adding value to a good in our model, all the labour $L_n$ available in $n$ is used. Thus, this model implies full employment.


<br>


In order to recap the latter part of this exercise and connect it with Exercise 2.4 b), **your task** now is to answer the following quiz. If you want to, you may also use the free code chunk. If you decide to do so, possibly you first need to read in the data.
```{r "2_5__3",optional=TRUE}
trade <- read.csv("trade.csv")
io <- read.csv("io.csv")
```

You can use the following chunk freely.

```{r "2_5__4",optional=TRUE}
# Enter your code here
# do not forget to remove the hash keys `#`
```


#! addon__quiz__Rest of 2.5

<br>

This exercise showed you how several important parameters are linked in our model. Now only the definition of the equilibrium we want to solve is needed to complete the model's introduction. 

<br>


## Exercise 2.6 -- The Equilibrium
In this exercise, you will get to know the definitions of the 'normal' equilibrium and the **equilibrium in relative changes**. The first is basically what we and CP are interested in and the second is based on it, alleviating calculations and making some variables redundant. Hence we will solve for the latter equilibrium throughout this RTutor problem set.

<br>

#### Definition 1 - Equilibrium under Tariff Structure $\mathbf{\tau}$

An **equilibrium under tariff structure** $\mathbf{\tau}$ is a wage vector $\mathsf{w} \in \mathbb{R}^N$, $\mathsf{w^i}\geq 0 ~ \forall i \in (1,\dots,N)$ and prices $\mathbf{P^j_n}$ for $j=\{1\dots J\}, n=\{1\dots N\}$, given labour $L_n$, deficits $D_n$, location parameters of the Frechet distribution $\lambda^j_n$ and iceberg trading costs $d^j_{ni}$,
for which the equations **(1) -- (5)** are satisfied $\forall j,n$. These equations are already presented in Exercises 2.3 and 2.5, below you can find them again in a more concentrated way.



$$\tag{1} c^j_n = A^j_n \mathsf{w}^{\gamma^j_n}_n \cdot \prod^J_{k=1} {P^k_n}^{\gamma^{k,j}_n}.$$
$$\tag{2} P^j_n = \Upsilon^j \left[ \sum^N_{i=1} \lambda^j_i (c^j_i \kappa^j_{ni})^{-\theta^j} \right]^{-\frac{1}{\theta^j}}.$$
$$\tag{3} \pi^j_{ni} = \frac{\lambda^j_i \left[ c^j_i \kappa^j_{ni} \right]^{-\theta^j}}{\sum^N_{h=1} \lambda^j_h \left[ c^j_h \kappa^j_{nh} \right]^{-\theta^j}}.$$
$$\tag{4} X^j_n= \sum^J_{k=1}\gamma^{j,k}_n \sum^N_{i=1} X^k_i \frac{\pi^k_{in}}{\tilde{\tau}^k_{in}} + \alpha^j_nI_n.$$
$$\tag{5} \sum^J_{j=1} \sum^N_{i=1} \frac{X^j_{ni}}{\tilde{\tau}^j_{ni}}-D_n = \sum^J_{j=1} \sum^N_{i=1} \frac{X^j_{in}}{\tilde{\tau}^j_{in}}.$$

<br>



Solving for this equilibrium would already be sufficient to obtain meaningful results for the paper's purpose.

However, in the article we study, the aim is to find an equilibrium in relative changes rather than an equilibrium in absolute values. Thus, we solve for **changes** in wages and prices that occur after changing the tariff structure $\tau$ to tariff structure $\tau'$.   
Advantages that arise from this approach are, firstly, to be able to identify the calculation outcomes with concrete changes in tariffs. Secondly, there is the possibility to calibrate the model exactly to the year before NAFTA came into effect. This means that it is possible to perform a range of analyses for several types of tariff changes and for various settings of the global economy. Examples are assumptions of no tariff changes in non-NAFTA members or a world with no trade deficits. A third advantage is, that some parameters that are assumed to be constant over time cancel out and need not to be identified or estimated. 

<br>


Define now the equilibrium of the model under tariff structure $\tau'$ relative to tariff structure $\tau$.

#### Definition 2 - Equilibrium in Relative Changes

Let $(\mathsf{w},P)$ be an equilibrium under tariff structure $\tau$, let $(\mathsf{w}^\prime,P^\prime)$ be an equilibrium under tariff structure $\tau^\prime$ (see Definition 1). Define a variable with a 'hat', (e.g. $\hat{x}$) to stand for the relative change of the variable, namely $\hat{x}=\frac{x^\prime}{x}$. Using equations **(1) -- (5)**, CP derive the conditions for the **equilibrium in relative changes** which fulfils the following equations **(6) -- (10)**.



Cost of the input bundles:
$$\tag{6} \hat{c}^j_n=\hat{\mathsf{w}}^{\gamma^j_n}_n \prod^J_{k=1} \left(\hat{P}^k_n \right)^{\gamma^{kj}_n}.$$
Price index:
$$\tag{7} \hat{P}^j_n = \left[\sum^N_{i=1}\pi^j_{ni}[\hat{\kappa}^j_{ni} \hat{c}^j_i]^{-\theta^j}  \right]^{-\frac{1}{\theta^j}}.$$
Bilateral trade shares:
$$\tag{8} \hat{\pi}^j_{ni}=\left[ \frac{\hat{c}^j_i \hat{\kappa}^j_{ni}}{\hat{P}^j_n} \right]^{-\theta^j}.$$
Total expenditure in each country $n$ and sector $j$:
$$\tag{9} {X^j_n}^\prime= \left( \sum^J_{k=1}\gamma^{jk}_n \sum^N_{i=1} \frac{{\pi^k_{in}}^\prime}{1+{\tau^k_{in}}^\prime} {X^k_i}^\prime  \right) + \alpha^j_n {I_n}^\prime.$$
Trade balance:
$$\tag{10} \sum^J_{j=1}\sum^{N}_{i=1} \frac{{\pi^j_{ni}}^\prime}{1+{\tau^j_{ni}}^\prime} {X^j_n}^\prime - D_n = \sum^J_{j=1}\sum^{N}_{i=1} \frac{{\pi^j_{in}}^\prime}{1+{\tau^j_{in}}^\prime} {X^j_i}^\prime,$$

where ${I_n}^\prime=\hat{\mathsf{w}}_n\mathsf{w}_n L_n + \sum^J_{j=1}\sum^N_{i=1} {\tau^j_{ni}}^\prime \frac{{\pi^j_{ni}}^\prime}{1+{\tau^j_{ni}}^\prime} {X^j_n}^\prime +D_n,$   
${\tilde{\tau}^{j\prime}_{ni}} = 1+ {\tau^{j\prime}_{ni}}$ and
$\hat{\kappa}^j_{ni}=\frac{1+{\tau^j_{ni}}^\prime}{1+\tau^{j}_{ni}}.$

<br>

Note that this last formula for $\hat{\kappa}^j_{ni}$ demonstrates exactly what is one of the advantages of calculating the equilibrium in relative changes. Originally, in the model we had $\kappa^j_{ni}=(1+\tau^{j}_{ni}) \cdot d^j_{ni}$ with iceberg trading costs $d^j_{ni}$. The latter are very difficult to observe and estimating them could increase the potential errors. Through the relative changes approach however the iceberg trading costs, which can be assumed to be constant over time, cancel out which makes calculations easier. Similarly the $\lambda^j_n$, parameters of the Frechet distribution for the efficiency of production that would be needed to estimate otherwise, cancel out in the formula for changes in bilateral trade shares $\hat{\pi}^j_{ni}$.
 
<br>

Now that we have learned all main aspects of the model CP solve, it is **your task** to answer the following quiz about the equilibrium.

#! addon__quiz__The Equilibrium


<br>

<br>


## Exercise 3 - Code for Finding the Equilibrium and Welfare Effects

As we learned earlier in Exercise 2 a), CGE models tend to become 'black boxes' due to their complexity and lack of transparency. CP address this issue and construct a rather transparent and simple model. Nonetheless, performing all the calculation steps in the course of this RTutor problem set goes by far beyond its scope since the model is still too complex and requires far too much calculation power.

Here, in Exercises 3 to 3.5, we present calculations which lead to the **equilibrium in relative changes** whose definition was presented in Exercise 2.6. 

Admittedly, there are faster ways of solving for the equilibrium as presented in these exercises and in the code in the note at the end of Exercise 3. If you are interested in a discussion of this issue, see the following info box.

info("The balance between transparency and calculation efficiency") # Run this line (Strg-Enter) to show info

As a guideline, only Exercise 3.2 is designed to be worked through entirely. In Exercises 3, 3.1 and 3.3 to 3.5, there will be several abbreviations, so that you can choose if you want to see more programming code, explanations or theoretical background. Abbreviations are for example notes and info boxes which are usually optional, or an indication that you can skip the remaining of the current exercise.

<br>

For demonstration purposes, in this RTutor problem set we restrict the model to only two countries and two sectors, one tradable and one non-tradable, because of the high calculation power needed. Furthermore, we will actually perform only little part of the calculations because even the restricted model takes too much calculation time. Anyway, the whole code to obtain the equilibrium is given at the end of this Exercise 3 and the calculations are presented in such a way, that with only slight adaptations they calculate the equilibria for any chosen sets of countries and sectors. Furthermore, in Exercise 4 we discuss the results of the whole dataset as CP obtain them.  
See the following info box for an explanation how the data is restricted to two countries and two sectors so that the linkages between sectors and countries still make sense.  

<br>

info("The methodology of restricting the model within this RTutor problem set") # Run this line (Strg-Enter) to show info

<br>

In our example we take the two NAFTA member countries Mexico and the United States, trading products from the tradable textile sector and having a retail system, a non-tradable sector. 

**Your task** now is to read in the data frames `dta` and `ioc` and to have a quick glance at them. They are already restricted to the two countries and sectors we focus on here. Additionally, the parameters we need and which we introduced and/or calculated in Exercise 2 are given in these data frames. Finally, the underlying data is already calibrated to the base year 1993. That means that slight adaptations of the underlying data were performed. The reason for this last procedure is that the model should return the result "no trade and welfare effects occurred" in the case when no tariffs changed. In other words, setting the tariffs of 2005 equal to the tariffs from 1993 after calibration results in no trade flow and welfare changes. This would not have been the case without calibration.
```{r "3___Code_for_Finding"}
dta <- read.csv("dta_equilibrium.csv")
ioc <- read.csv("ioc_equilibrium.csv")
dta
ioc
```
Here we can see that the data frame `ioc` was built on the basis of the data frame `io`, adding the $\gamma^{kj}_n$ which we introduced and calculated in Exercise 2.4 d).  
The data frame `dta` contains many more variables. Note that the basis of the data frame `dta` is a data frame `trade2` instead of `trade` which we worked with in former exercises. The difference between the two data frames is that `trade2` extends `trade` by rows where the source and the destination countries are the same. The trade flows and the tariffs are zero in these cases. We use this new data frame, because in the course of the calculations there will be many steps where for example the product of $\pi^j_{nn}$ or $\kappa^j_{nn}$ with another term is used in a sum. See equations **(7)**, **(9)** and **(10)** for examples. Since we do not want to consider all the special cases and exceptions by not having at hand those values, we use data frame `trade2` where we can treat these values just in the standard way we treat the $\pi^j_{ni}, n \neq i$.

<br>

Despite huge calculation time savings, even with these data frames it is not possible to calculate the equilibrium of equations **(6)-(10)** straightforward, nor in an analytical way. Instead, CP calculate an equilibrium numerically, which is the CGE method (see Exercise 2 a). When somebody tries to find an equilibrium numerically, almost surely none of the equations will hold exactly. This is why beforehand CP define a very small error they accept to ignore. CP accept an error of `1E-07` ($=0.0000001$); in the case of not exceeding it they declare that the equations hold numerically.

At the beginning of each iteration, CP guess wages $\hat{\mathsf{w}}$ of the countries in the model. Then they calculate equations **(6)-(7)** numerically and based on this equations **(8)-(9)** analytically. Finally they check if equation **(10)** holds up to the marginal error of `1E-07`. If this is not the case, they adapt their guess of wages $\hat{\mathsf{w}}$ in a sensible way and repeat their procedure. In the first iteration it makes sense to guess that new wages $\mathsf{w}'$ are the old wages $\mathsf{w}$, thus $\hat{\mathsf{w}}=\frac{\mathsf{w}'}{\mathsf{w}}$ is guessed to equal $1$.  
Consequently, the calculation of the equilibrium considerably takes time due to many needed iterations of the `while` loop. Additionally, as we will see in Exercise 3.1, in order to find a costs and prices vectors that fit together (equations **(6)-(7)** are inter-dependent), another `while` loop inside the loop is needed for a numerical equilibrium inside the CGE.  
So during this RTutor problem set, we only perform a small part of one iteration to keep things short.


Now **your task** is to solve the following questions on this exercise (in question 3, 'w_hat' stands for $\hat{\mathsf{w}}_n$).

#! addon__quiz__Exercise 3

<br>

The following note gives the entire code which helps to find the equilibrium in relative changes, adapted from CP. The code is pretty large, so it is given here just in case you want to work with it. 

For the usual purpose of the RTutor problem set, just continue with Exercise 3.1.

#! start_note "Note: The whole code for finding the equilibrium in relative changes"



```
#setwd("...")
#rm(list=ls())
library("dplyr", lib.loc="~/R/win-library/3.2")
library("reshape2", lib.loc="~/R/win-library/3.2")
trade2 <- read.csv(file="trade2.csv") 
io <- read.csv(file="io.csv")

#################################
########## initialization
countries <- data.frame(countries=matrix(c("Mexico","USA"),ncol=1))
sectors <- data.frame(sectors=matrix(c("Textile","Retail"),ncol=1))
base_year <- TRUE
########## end initialization
#################################


small_sample_equilibrium <- function(cou=countries,sec=sectors,by=base_year, tra=trade2,
                              ioc=io, tol=1e-7,maxit=1e4, vfactor=-0.2, input=NULL){
countries=cou; sectors=sec; base_year=by; trade2=tra; io=ioc

N <- length(countries[[1]])
J <- length(sectors[[1]])

# assumption that the rest of the GO is consumed in the country ==> domsales are higher
dta <- mutate(trade2, selection=0)
dta <- mutate(dta, selection=
    ifelse(is.element(Source_C,countries[[1]]),selection+1, selection))
dta <- mutate(dta, selection=
    ifelse(is.element(Dest_C,countries[[1]]),selection+1, selection))
dta <- mutate(dta, selection=
    ifelse(is.element(Sector,sectors[[1]]),selection+1, selection))

dta <- filter(dta,selection==3)
dta <- select(dta,-selection)

# only if we are calibrating the model to the data from 1993
if(base_year) dta <- mutate(dta,Tariffs2005=Tariffs1993)

ioc <- io %>%
  mutate(selection=0) %>%
  mutate(selection=ifelse(is.element(Country,countries[[1]]),selection+1,selection)) %>%
  mutate(selection=ifelse(is.element(Source_S,sectors[[1]]),selection+1,selection)) %>%
  mutate(selection=ifelse(is.element(Dest_S,sectors[[1]]),selection+1,selection)) %>%
  filter(selection==3) %>%
  select(-selection)
  ## keep proportions ==> assumption that proportions stay the same, sum must be 100
ioc_tmp <- summarize(group_by(ioc,Country,Dest_S),total=sum(IO_Coeff))
ioc_tmp <- inner_join(ioc,ioc_tmp, by=c("Country","Dest_S"))
ioc_tmp <- mutate(ioc_tmp,IO_Coeff=IO_Coeff/total)

ioc <- select(ioc_tmp,-total)
  
#####################################
### START OF CALIBRATION ############
### already included in dta and ioc #
### in the 2 country 2 sector case ##
#####################################

## domestic sales
exports_temp <- dta %>%
  group_by(Source_C,Sector) %>%
  summarize(Exports_Source=sum(Trade_Vol))

dta <- inner_join(dta,exports_temp, by=c("Sector", "Source_C"))
## adapt gross output
dta <- mutate(dta,Domsales_Source =pmax(0, GO_Source-Exports_Source))
dta$GO_Source <- dta$Domsales_Source + dta$Exports_Source

# Expenditures
dta <- mutate(dta,Expend=(1+Tariffs1993/100)*Trade_Vol)

foreign_expend <- dta %>%
  group_by(Dest_C, Sector) %>%
  summarize(sum_foreign_expenditure=sum(Expend)) 
foreign_expend_source_dest_switch <- foreign_expend       
names(foreign_expend_source_dest_switch)[1] <- "Source_C" 
dta <- inner_join(dta,foreign_expend_source_dest_switch, by=c("Sector", "Source_C"))
## Expend_Source stands for the total expenditure of Source_C on goods from this sector
dta <- dta %>%
  mutate(Expend_Source=sum_foreign_expenditure+Domsales_Source) %>%
  select(-sum_foreign_expenditure)

## dta_temp has switched source-dest and thus Expend_Source should be Expend_Dest
dta_temp <- dta
names(dta_temp)[c(2,3)] <- names(dta)[c(3,2)]
dta_temp <- select(dta_temp,Sector, Source_C,Dest_C,Expend_Dest =Expend_Source)
dta <- inner_join(dta,dta_temp, by=c("Sector", "Source_C","Dest_C"))
dta <- mutate(dta,Expend_Shares =Expend/Expend_Dest)
dta <- mutate(dta,Expend_Shares = 
    ifelse(Source_C==Dest_C, Domsales_Source/Expend_Source, Expend_Shares))
rm(dta_temp)

## construct Imports_Source and Exports_Source
## tariffs excluded
exports <- dta %>%
  group_by(country=Source_C) %>%
  summarize(exports=sum(Trade_Vol))
imports <- dta %>%
  group_by(country=Dest_C) %>%
  summarize(imports=sum(Trade_Vol))
trade_def <- inner_join(imports,exports,by="country")
trade_def <- transmute(trade_def, Source_C=country,Total_Exports_Source=exports, 
                       Superavit_Source=exports-imports)
dta <- inner_join(dta,trade_def,by="Source_C")
rm(exports,imports,trade_def)

## Value Added
va_temp <- dta %>%
  group_by(Source_C) %>%
  summarize(VA_Total_Source = sum(GO_Source*VA_Source)/(N-1)/100)
dta <- inner_join(dta,va_temp,by="Source_C")
rm(va_temp)
va_temp <- dta %>%
  group_by(Source_C,Sector) %>%
  summarize(VA_Sector = sum(GO_Source*VA_Source)/(N-1)/100)
dta <- inner_join(dta,va_temp,by=c("Source_C","Sector"))
rm(va_temp)

## alphas = total expenditure - intermediate goods expenditure, normalized countrywise
## material_need_demander is the total material need that the demanding sector asks for
## find the materials need of the demanding sector
alphas_temp <- dta %>%
  mutate(material_need_demander=(Exports_Source+Domsales_Source)*(100-VA_Source)/100)
alphas_temp <- transmute(alphas_temp, Country=Source_C,Dest_S=Sector,
                         material_need_demander=material_need_demander)
alphas_temp <- distinct(alphas_temp)

## find the materials need of the supplying sector
alphas_temp <- inner_join(io,alphas_temp,by=c("Country","Dest_S"))
alphas_temp <- mutate(alphas_temp, need_times_io =material_need_demander*IO_Coeff/100)
alphas_temp <- alphas_temp %>%
  group_by(Country,Source_S) %>%
  summarize(material_need_supplier = sum(need_times_io))
  
## calculate the numerator of alpha
alphas_temp <- select(alphas_temp, Sector=Source_S, Source_C=Country, 
    material_need_supplier)
alphas_temp <- inner_join(dta,alphas_temp, by=c("Sector","Source_C"))
alphas_temp <- mutate(alphas_temp, 
    numerator = pmax(0, Expend_Source - material_need_supplier))
    
## find sum of numerators to normalize
alphas_denom <- alphas_temp %>%
  select(Source_C,Sector,numerator) %>%
  group_by(Source_C) %>%    
  summarize(denominator = sum(numerator)/N)
alphas_temp <- left_join(alphas_temp, alphas_denom, by=c("Source_C"))
alphas_temp <- mutate(alphas_temp, Alpha_Source = numerator/denominator)

alphas_temp <- select(alphas_temp, -numerator, -denominator, - material_need_supplier)

dta <- alphas_temp
rm(alphas_temp, alphas_denom, exports_temp, foreign_expend_source_dest_switch, 
    foreign_expend, ioc_tmp)

##################################
########### calculate GAMMA_KJ_N
##################################
# gamma_kj_n in percent
gamma_temp <- inner_join(ioc, distinct(select(dta,Sector,Source_C,VA_Source)) ,
                         by=c("Dest_S"="Sector", "Country"="Source_C"))
gamma_temp <- mutate(gamma_temp, Gamma_kjn= IO_Coeff/100*(100-VA_Source))
ioc <- gamma_temp

#################################################
### Until here is included in dta and ioc #######
#################################################

#   ###################################
#   #   Main Program Counterfactuals
#   ###################################


if (is.null(input)){
  wf0 <- data.frame(Country= unique(dta$Source_C))
  wf0 <- bind_cols(wf0,data.frame(wages= matrix(1,nrow=N)))
} else {
  wf0 <- input$wf0
}
pf0 <- expand.grid(Country=unique(dta$Source_C) , Sector=unique(dta$Sector)) 
pf0 <- bind_cols(pf0,data.frame(prices= matrix(1,nrow=N*J)))

e <- 1
wfmax <- 100000

while (e <= maxit && wfmax > tol){

  cphat <- equations67(wages=wf0, df=dta, ioc=ioc, J=J, N=N, maxit=maxit, tol=tol, 
      vfactor=vfactor)

  # Calculating trade shares
  piprime <- equation8(df=dta, cp=cphat, J=J, N=N)
  piprime <- mutate(piprime,piprime_discounted =piprime/(1+Tariffs2005/100))

  # Expenditure
  xprime <- equation9(dta=piprime, ioc=ioc, cp=cphat, J=J, N=N, wf0=wf0, tol=tol)
  
  # Iterating using LMC - Labour Market Clearing, p.10 CP
  wages_new <- equation10(dta=piprime ,x = xprime) 
  
  # Equation 10 itself and end of iteration
  
  # exports
  ex <- inner_join(piprime,xprime, by=c("Sector","Dest_C"="Country"))
  ex <- ex %>%
    group_by(Source_C) %>%
    summarize(ex = sum(X*piprime_discounted))
  # imports
  im <- inner_join(piprime,xprime, by=c("Sector","Dest_C"="Country"))
  im <- im %>%
    group_by(Dest_C) %>%
    summarize(im = sum(X*piprime_discounted))
  
  # check for closeness to target value (equality in Equation 10)
  superavit <- piprime %>%
    select(Source_C,superavit=Superavit_Source,VA_Total_Source) %>%
    distinct() 
  error <- inner_join(inner_join(ex,im, by=c("Source_C"="Dest_C")), superavit, 
      by="Source_C")
  error <- mutate(error, error=ex-im-superavit)
  wfmax <- max(abs(error$error))
  print(cat("wfmax:",wfmax, "\n"))

  # adapt wages
  # no minus sign in front of error, already good
  error <- mutate(error, adaptation_step = error/VA_Total_Source) 
  wf1 <- inner_join(wf0,error, by=c("Country"="Source_C"))
  wf1 <- mutate(wf1, wages_next= wages*(1-vfactor*adaptation_step/wages))
  wf0 <- select(wf1,Country, wages=wages_next)

  print(cat("e:",e, "\n"))
  e <- e+1
} # end while


xbilattau <- inner_join(piprime,xprime, by=c("Dest_C"="Country","Sector"))
xbilattau <- mutate(xbilattau, xbilattau=X*piprime_discounted, 
    xbilatp = ifelse(Source_C!=Dest_C,X*piprime,0))
    
GO_Source_new <- xbilattau %>%
  group_by(Sector,Source_C) %>%
  summarize(GO_Source = sum(xbilattau))

# alphas and piprime are included in piprime
# xbilatp is included in xbilattau
list(xbilattau=xbilattau, GO_Source_new =GO_Source_new, wf0=wf0, error=error,
     xprime=xprime, piprime=piprime, cphat=cphat)

} # end function

#################################
equations67 <- function(wages, df,ioc,J,N,maxit,tol,vfactor){

  
  #initialize vectors of ex-post wage and price factors 
  wf0 = wages
  pf0 <- expand.grid(Country=unique(df$Source_C) , Sector=unique(df$Sector)) 
  pf0 <- bind_cols(pf0,data.frame(prices= matrix(1,nrow=N*J)))
  
  pfmax    = 100000
  it       = 1
  
  while (it <= maxit && pfmax > tol){
    wf0 <- mutate(wf0, logwages = log(wages))
    pf0 <- mutate(pf0,logprices =log(prices))
    
    # equation 6
    eq6_temp <- inner_join(ioc,pf0, by=c("Country","Source_S"="Sector"))
    eq6_temp <- summarize(group_by(eq6_temp,Country, Dest_S), 
      pgamma =  sum(logprices*Gamma_kjn),VA_Source=mean(VA_Source))
    
    eq6_temp <- inner_join(eq6_temp,wf0, by="Country")
    eq6_temp <- mutate(eq6_temp, lc= VA_Source/100*logwages + pgamma, cc= exp(lc))

    # equation 7
    eq7_temp <- inner_join(df,select(eq6_temp,Country,Sector=Dest_S, cc), 
        by=c("Dest_C"="Country","Sector"))
    eq7_temp <- eq7_temp %>%
      mutate(summand_11 = ((1+Tariffs2005/100)/(1+Tariffs1993/100)*cc)^-Trade_Elast) %>%
      group_by(Dest_C,Sector) %>%
      summarize(pjn11=sum(Expend_Shares*( summand_11 ))) 
    eq7_temp <- inner_join(eq7_temp,distinct(select(df,Sector,Trade_Elast)), by="Sector")
    eq7_temp <- mutate(eq7_temp, phat= ifelse(pjn11!=0, pjn11^-(1/Trade_Elast) ,1) )
    names(eq7_temp)[1] <- "Country"
    
    # checking tolerance
    names(pf0)[3] <- "prices_old"
    pf0 <- inner_join(pf0,eq7_temp, by=c("Country","Sector"))
    pf0 <- mutate(pf0, pfdev=abs(phat-prices_old))
    pfmax <- max(pf0$pfdev)
    pf0 <- select(pf0, Country, Sector, prices=phat)

    it <- it +1
  }
  output <- inner_join(pf0, select(eq6_temp, Country, Sector=Dest_S, cc), 
      by=c("Country","Sector"))
  output
}

################################
equation8 <- function(df, cp, J, N){
  ### LOOK FOR PIPRIME, not only pi_hat
  
  eq8_temp <- inner_join(df,select(cp,Country,Sector,cc),
      by=c("Source_C"="Country","Sector"))
  eq8_temp <- inner_join(eq8_temp, select(cp, Country, Sector, prices), 
      by=c("Dest_C"="Country", "Sector"))
  eq8_temp <- mutate(eq8_temp, 
      piprime =
      Expend_Shares*( ((1+Tariffs2005/100)/(1+Tariffs1993/100)*cc/prices)^-Trade_Elast) )
  # normalize expenditure shares to remove small inconveniences
  normalizer <- eq8_temp %>%
    group_by(Sector,Dest_C) %>%
    summarize(normalizer=sum(piprime))
  eq8_temp <- inner_join(eq8_temp,normalizer, by=c("Sector","Dest_C"))
  eq8_temp <- mutate(eq8_temp, piprime=piprime/normalizer)
  eq8_temp <- select(eq8_temp, -prices, -cc,-normalizer)
  eq8_temp
}

######################################
equation9 <- function(dta, ioc, cp, J,N, wf0, tol){

  # # first, keep expenditure of first country and first tradable sector fixed  
  rhs <- inner_join(dta,wf0,by=c("Source_C"="Country"))
  rhs <- rhs %>%
    mutate(rhs = Alpha_Source*(wages*VA_Sector - Superavit_Source)) %>%
    select(Country=Source_C,Sector,rhs) %>%
    distinct()

  # to calculate X_prime, the new expenditures
  # first use the old expenditures
  X <- expand.grid(Country=unique(dta$Source_C) , Sector=unique(dta$Sector))
  X <- inner_join(X,distinct(select(dta,Sector, Country=Source_C, X=Expend_Source)), 
      by= c("Country", "Sector"))
  X_origin <- X
  # just construct a is.zero for the beginning of the loop, with entries 0
  is.zero <- select(mutate(X,is.zero=0),-X)
  X_min <- inner_join(X, is.zero, by=c("Sector","Country"))
  
  
  iteration <- 1
  delta <- 1e10
  approach_factor <- 1e5
  while(delta>tol && iteration<=1000 ){

    X <- mutate(X_min, X= (1 -is.zero/1e6) * X)
    X <- select(X,-is.zero)
    
    # X2 is the material need for all countries and sectors
    X2 <- inner_join(dta,X,by=c("Sector","Dest_C"="Country"))
    X2_temp <- X2 %>%
      group_by(Source_C,Sector) %>%
      summarize(pitaux = sum(piprime_discounted*X)) 
    X2_temp <- inner_join(ioc,X2_temp, by=c("Country"="Source_C","Dest_S"="Sector"))
    X2_temp <- X2_temp %>%
      group_by(Country, Source_S) %>%
      summarize(material_need=sum(pitaux*Gamma_kjn)) %>%
      select(Country,Sector=Source_S,material_need)

    # X3 is alpha multiplied with the tariff revenue of the households
    X3 <- inner_join(dta,X, by=c("Sector","Dest_C"="Country"))
    X3_temp <- X3 %>%
      group_by(Dest_C) %>%
      summarize(tariff_revenues = sum(Tariffs2005/100 * X * piprime_discounted))
    X3_temp <- inner_join(X3,X3_temp,by=c("Source_C"="Dest_C"))
    X3_temp <- distinct(transmute(X3_temp, Country=Source_C, Sector=Sector, tariff_revenues=tariff_revenues*Alpha_Source))

    equation_a <- inner_join(X,X2_temp, b=c("Country", "Sector"))
    equation_b <- inner_join(X3_temp,rhs, b=c("Country", "Sector"))
    equation <- inner_join(equation_a,equation_b, b=c("Country", "Sector"))
    # 'is.zero' should be zero
    equation <- mutate(equation,is.zero = X - material_need - tariff_revenues - rhs)

    delta_new <- max(abs(equation$is.zero))

    is.zero <- select(equation,Sector,Country,is.zero)
    if(delta_new < delta){
      delta <- delta_new
      X_min <- X
      is.zero_min <- is.zero
      X_min <- inner_join(X_min, is.zero_min, by=c("Sector","Country"))
    }

    

    iteration <- iteration +1
  }
  select(equation,Sector, Country,X)
}

######################################
# equation 10 equivalent to labour market clearing, p.10 CP
equation10 <- function(dta, x){
  w_temp <- inner_join(dta,x,by=c("Dest_C"="Country", "Sector"))
  w_temp <- w_temp %>%
    group_by(Source_C,Sector) %>%
    summarize(vaxpidisc = sum(X*piprime_discounted*(VA_Source/100)/VA_Total_Source)) %>%
    group_by(Source_C) %>%
    summarize(wages_new = sum(vaxpidisc))

  w_temp
}
```
#! end_note

<br>

## Exercise 3.1 -- Solving for Costs and Prices - Equations 6 & 7

Here we will see how CP solve for costs and prices in each iteration of their equilibrium calculation process.

Recall the two equations with which we will calculate the costs of input bundles and price indices:

$$\tag{6} \hat{c}^j_n=\hat{\mathsf{w}}^{\gamma^j_n}_n \prod^J_{k=1} \left(\hat{P}^k_n \right)^{\gamma^{kj}_n},$$
$$\tag{7} \hat{P}^j_n = \left[\sum^N_{i=1}\pi^j_{ni}[\hat{\kappa}^j_{ni} \hat{c}^j_i]^{-\theta^j}  \right]^{-\frac{1}{\theta^j}}.$$

Taking the logarithm of these equations results in:
$$ \ln( \hat{c}^j_n) = \gamma^j_n \ln (\hat{\mathsf{w}}) + \sum^J_{k=1} \gamma^{kj}_n \ln(\hat{P}^k_n),$$
$$ \ln(\hat{P}^j_n) = -\frac{1}{\theta^j} \cdot \ln \left(\sum^N_{i=1}\pi^j_{ni}[\hat{\kappa}^j_{ni} \hat{c}^j_i]^{-\theta^j}  \right).$$ 

Note that, despite using the term 'equation' when referring to equation **(6)** or **(7)**, we are usually talking about the whole set of equations, namely one equation for every country-sector pair (n-j pair). This means 1240 equations for the whole set that CP use and still four equations for our subset of two countries and two sectors.


From the above equations we see that on the one hand we can perform calculations in a somehow easier way with more summands and less exponents. On the other hand, the $\hat{c}^j_n$ and the $\hat{P}^j_n$ are interdependent, meaning that one $\hat{c}^j_n$ depends on many $\hat{P}^k_i$, which in turn depend on many $\hat{c}^l_m$. This means that we have to find the $\hat{P}^j_n$ numerically so that equations **(6)** and **(7)** are fulfilled via a `while` loop. In other words, we have to find a numerical equilibrium within a CGE.


Analogously to the guess of wages for the whole equilibrium, we have to guess prices in order to find an equilibrium that fulfils both equations **(6)** and **(7)** in the first iteration. As we did it with the wages in the first iteration, we guess $\hat{P}^j_n =1$.


Now **your task** is to solve the following questions on this exercise (in question 3, 'P_hat' stands for $\hat{P}^j_n$).

#! addon__quiz__Exercise 3.1


<br>

The remaining of this Exercise 3.1 is optional for the case that you want to see all the code. If not, simply jump forward to Exercise 3.2.

#! start_note "Note: The code for equations 6 & 7"

This code creates the data frames for initial wages `wf0` and for initial prices `pf0`.
```
wf0 <- data.frame(Country= unique(dta$Source_C))
wf0 <- bind_cols(wf0,data.frame(wages= matrix(1,nrow=2)))

pf0 <- expand.grid(Country=unique(dta$Source_C) , Sector=unique(dta$Sector)) 
pf0 <- bind_cols(pf0,data.frame(prices= matrix(1,nrow=2*2)))
```


```
eq6_temp <- inner_join(ioc,pf0, by=c("Country","Source_S"="Sector"))
eq6_temp <-  eq6_temp %>%
  group_by(Country, Dest_S) %>%
  summarize(pgamma = sum(log(prices)*Gamma_kjn),VA_Source=mean(VA_Source))
    
eq6_temp <- inner_join(eq6_temp,wf0, by="Country")
eq6_temp <- mutate(eq6_temp, logcost= VA_Source/100*log(wages) + pgamma, 
    cost= exp(logcost))
```

```
eq7_temp <- inner_join(dta,select(eq6_temp,Country,Sector=Dest_S, cost), 
    by=c("Dest_C"="Country","Sector"))
eq7_temp <- eq7_temp %>%
  mutate(summand_7 = ((1+Tariffs2005/100)/(1+Tariffs1993/100)*cost)^-Trade_Elast) %>%
  group_by(Dest_C,Sector) %>%
  summarize(pjn7=sum(Expend_Shares*( summand_7 ))) 
eq7_temp <- inner_join(eq7_temp,distinct(select(dta,Sector,Trade_Elast)), by="Sector")
eq7_temp <- mutate(eq7_temp, phat= ifelse(pjn7!=0, pjn7^-(1/Trade_Elast) ,1) )
names(eq7_temp)[1] <- "Country"
eq7_temp
```
Now let us have a look if the prices ('phat') we get from equation **(7)** and which are consistent with the costs we calculated with equation **(6)** are actually the prices we guessed in the beginning of this iteration. Those were called 'prices', we will rename them to 'prices_old' in each iteration to distinguish between old and new prices.

```
names(pf0)[3] <- "prices_old"
p_temp <- inner_join(pf0,eq7_temp, by=c("Country","Sector"))
pf0 <- mutate(p_temp, pf_difference=abs(phat-prices_old))
pf0 
```
As expected, the difference between the two different prices is significant, at least in the case of Mexico. This means that we have not yet found prices which are consistent with both sets of equations **(6)** and **(7)**. For the next iteration, the prices (phat) are the new starting value.

<br>

The remaining of this note is the whole code for equations **(6)** and **(7)** assembled together in one single block.    
As discussed in the note in Exercise 3, there are more efficient ways of solving for prices and costs at the same time, than we do it here. Since our code is pretty transparent, you can figure out more easily what is going on compared to using highly efficient code. This is the advantage of our code and even with the more efficient code we could not perform the calculations within the scope of an RTutor problem set.

```
wf0 <- data.frame(Country= unique(dta$Source_C))
wf0 <- bind_cols(wf0,data.frame(wages= matrix(1,nrow=2)))

pf0 <- expand.grid(Country=unique(dta$Source_C) , Sector=unique(dta$Sector)) 
pf0 <- bind_cols(pf0,data.frame(prices= matrix(1,nrow=2*2)))

maximum_difference    = 100000
maximum_iterations    = 1000
iteration_number      = 1
tolerance = 0.01
  
while (iteration_number <= maximum_iterations && maximum_difference > tolerance){

    # equation 6
    eq6_temp <- inner_join(ioc,pf0, by=c("Country","Source_S"="Sector"))
    eq6_temp <-  eq6_temp %>%
      group_by(Country, Dest_S) %>%
      summarize(pgamma = sum(log(prices)*Gamma_kjn),VA_Source=mean(VA_Source))
    
    eq6_temp <- inner_join(eq6_temp,wf0, by="Country")
    eq6_temp <- mutate(eq6_temp, logcost= VA_Source/100*log(wages) + pgamma, 
        cost= exp(logcost))
  
    # equation 7
    eq7_temp <- inner_join(dta,select(eq6_temp,Country,Sector=Dest_S, cost), 
        by=c("Dest_C"="Country","Sector"))
    eq7_temp <- eq7_temp %>%
    mutate(summand_7 = ((1+Tariffs2005/100)/(1+Tariffs1993/100)*cost)^-Trade_Elast) %>%
    group_by(Dest_C,Sector) %>%
    summarize(pjn7=sum(Expend_Shares*( summand_7 ))) 
    eq7_temp <- inner_join(eq7_temp,distinct(select(dta,Sector,Trade_Elast)), 
        by="Sector")
    eq7_temp <- mutate(eq7_temp, phat= ifelse(pjn7!=0, pjn7^-(1/Trade_Elast) ,1) )
    names(eq7_temp)[1] <- "Country"
    
    # checking tolerance
    names(pf0)[3] <- "prices_old"
    pf0 <- inner_join(pf0,eq7_temp, by=c("Country","Sector"))
    pf0 <- mutate(pf0, pf_difference=abs(phat-prices_old))
    maximum_difference <- max(pf0$pf_difference)
    pf0 <- select(pf0, Country, Sector, prices=phat)


    iteration_number <- iteration_number +1
}
pf0
```

#! end_note


<br>


## Exercise 3.2 -- Solving for Expenditure Shares - Equation 8
Having solved for costs and prices, in the next step use these parameters for the calculation of equation **(8)**, the expenditure shares. So it is **your task** now to load the needed data frames for the step that follows.
```{r "3_2",signif.digits=6}
dta <- read.csv("dta_equilibrium.csv")
ioc <- read.csv("ioc_equilibrium.csv")
cphat <- read.csv("cphat_equilibrium.csv")
cphat
```
Besides the standard data frames `dta` (derived from `trade`) and `ioc` (derived from `io`), you also loaded `cphat` in the chunk above. There you find the current values for $\hat{c}^j_n$ and $\hat{p}^j_n$ at this point of the equilibrium finding process. Namely, we are in the first iteration of the whole equilibrium, after finding the equilibrium for only $\hat{c}^j_n$ and $\hat{p}^j_n$, equations **(6)** and **(7)**. To get here, one has to run the full code with the loop in the note at the end of Exercise 3.1.  

<br>

For the following calculations in this exercise recall equation **(8)** for bilateral trade shares:
$$\tag{8} \hat{\pi}^j_{ni}=\left[ \frac{\hat{c}^j_i \hat{\kappa}^j_{ni}}{\hat{P}^j_n} \right]^{-\theta^j}.$$

Hence, preparing the calculations we will create a data frame `piprime`, in which all the variables we need are arranged in a suitable way. In particular, we have to pay attention to the indices $i$ and $n$. For example, the value for $\hat{c^j_i}$ needs to be in the row, where country $i$ is the exporting country. In other words, `cphat`'s variable `costs` needs to be arranged such that `cphat`'s factor `Country` fits to `dta`'s factor `Source_C`.  
Analogously, `cphat`'s variable `prices` must be arranged in a way that `cphat`'s factor `Country` fits to `dta`'s factor `Dest_C`.  
In addition to that, the sectors need to fit as well.

In the following code chunk, we merge the two data frames with the function `inner_join()` into the suitable formatting. More information on this function is available in the note "Joining data frames" in Exercise 1.3 a).  
In this function, arranging the variables exactly the way we have discussed it above is pretty easy. The parameter `by` allows for this action.  
**Your task** is now to consecutively add the columns `costs` and `prices` from the data frame `cphat` to the data frame `dta` just as we want them. 

```{r "3_2__2",signif.digits=6}
# adding costs
#  piprime <- inner_join(dta,select(cphat,Country,Sector,costs),
#                        by=c("???"="Country","Sector"))
# adding prices
#  piprime <- inner_join(piprime, select(cphat, Country, Sector, prices), 
#                        by=c("???"="Country", "Sector"))
#  piprime
```
As we see, the output of joining operation arranged the data exactly in the way we can use it directly in the next step to perform the calculations.

Despite it is true that equation **(8)** gives the calculation formula for $\hat{\pi}^j_{ni}$, in this part of the exercise our goal shall be to calculate the actual new expenditure shares ${\pi'}^j_{ni}$ instead, since this value will be of interest in the following steps of the algorithm. Therefore we still need exactly the arranged data frame `piprime` from the last code chunk.  
Note that 
$${\pi^{j\prime}_{ni}} =\hat{\pi}^j_{ni} \cdot \pi^j_{ni} = \pi^j_{ni} \cdot \left[ \frac{\hat{c}^j_i \hat{\kappa}^j_{ni}}{\hat{P}^j_n} \right]^{-\theta^j},$$
so we can calculate the target values in a straightforward way.

**Your task** is to calculate the ${\pi^{j\prime}_{ni}}$ according to the formula above. The data frame `dta` looks very much like the data frame `trade` which makes variable recognition easier. Still, if you need to look up the variable names, you can do so by pressing the `data` button at the head of the following code chunk and select the data frame `dta`. 

```{r "3_2__3",signif.digits=6}
#  piprime <- mutate(piprime, 
#                piprime =
#                  Expend_Shares*
#                  (((1+Tariffs2005/100)/(1+Tariffs1993/100)* ???/???)^-Trade_Elast))
#  piprime
```
As a result we now have the new market shares ${\pi^{j\prime}_{ni}}$ at this point of the equilibrium finding process. This already shows us that the equilibrium has not been found yet. Consider the property $\sum^N_{i=1} \pi^j_{ni} = 1$ which we discussed earlier, namely that all the countries' market shares in one market must add up to one. Additionally, also $\sum^N_{i=1} {\pi^{j\prime}_{ni}} = 1$ must hold.  
These two identities are also implied in equations **(8)** and **(3)**, as

$$\tag{3} \pi^j_{ni} = \frac{\lambda^j_i \left[ c^j_i \kappa^j_{ni} \right]^{-\theta^j}}{\sum^N_{h=1} \lambda^j_h \left[ c^j_h \kappa^j_{nh} \right]^{-\theta^j}}.$$

Note that in the code chunk above, the column `piprime` in the data frame `piprime` stands exactly for ${\pi^{j\prime}_{ni}}$. As we can check easily, the sum over destination countries $i$ does not sum up for both markets of the tradable sector 'textile'. In particular, we see easily that $0.509 +	0.31 \neq 1$ and $0.0598 +0.962 \neq 1$.  
Consequently, not all of the equilibrium conditions, namely equations **(6)-(10)**, can hold at this point of the iteration. Further iterations will be needed (see Exercise 3 for more information on numerical calculation). Still, the calculations for equations **(9)-(10)** will be run in this iteration, in order to find out to what extent the guesses of the wages $\hat{w_n}$ need to be adapted (see Exercise 3.1 for more on the guess of parameters).

<br>

Discussing the output of the code chunk in this exercise, on the one hand one could argue that it would be nicer to see only the relevant output variables. On the other hand, this output is a very good explanation for why we are skipping so many calculation steps throughout this RTutor problem set. As this output variable `piprime` indicates, numerous variables are actually needed in order to find the equilibrium and some of their calculations are rather expensive in terms of computing time. Additionally, some of the calculations need to be performed in each single iteration of a loop within a loop, which exponentiates the total computing time.

<br>

## Exercise 3.3 -- Solving for Expenditures - Equation 9
After the calculation of expenditure shares, CP solve for expenditures. Unlike this might seem at first view, this is no simple task. 

In order to find new expenditures, CP perform analytical matrix calculations in the style of $Ax=b \Leftrightarrow x=A^{-1}b$, where the matrix $A^{-1}$ is the inverse of the square matrix $A$ with 1240 rows and columns. The system of equations they solve with $Ax=b$ has an equation and a dependent variable for each country-sector combination, thus $31 \cdot 40 = 1240$ equations in just as many variables. See Appendix C in CP for more details.  
Throughout this RTutor problem set we do not work with matrices. Instead we employ data frames in order to keep a better visualization of the calculations we perform and to stay consistent in how we operate. Therefore, we cannot just invert a matrix in order to solve a system of equations. Here we show how to do this in a `while` loop, approaching equality of the right- and left-hand sides of equation **(9)** numerically.

<br>

Total expenditure in each country $n$ and sector $j$ has the representation
$$\tag{9} {X^j_n}^\prime= \left( \sum^J_{k=1}\gamma^{jk}_n \sum^N_{i=1} \frac{{\pi^k_{in}}^\prime}{1+{\tau^k_{in}}^\prime} {X^k_i}^\prime  \right) + \alpha^j_n {I_n}^\prime.$$


<br>

**Your task** is to answer the following questions on this exercise.

#! addon__quiz__Equation 9

Now, if you want to see the code for this procedure, see the following note, otherwise just continue with Exercise 3.4.

#! start_note "Note: The Equilibrium of Equation 9"
The following code is not executable here, since this would take too much time.  
As discussed in the note in Exercise 3, there are more efficient ways of solving for prices and costs at the same time, than we do it here. Since our code is pretty transparent, you can figure out more easily what is going on compared to using highly efficient code. This is the advantage of our code and even with the more efficient code we could not perform the calculations within the scope of an RTutor problem set.
```
rhs <- inner_join(dta,wf0,by=c("Source_C"="Country"))
rhs <- rhs %>%
  mutate(rhs = Alpha_Source*(wages*VA_Sector - Superavit_Source)) %>%
  select(Country=Source_C,Sector,rhs) %>%
  distinct()

# to calculate X_prime, the new expenditures
# first use the old expenditures
X <- expand.grid(Country=unique(dta$Source_C) , Sector=unique(dta$Sector))
X <- inner_join(X,distinct(select(dta,Sector, Country=Source_C, X=Expend_Source)), 
    by= c("Country", "Sector"))
X_origin <- X
# just construct a is.zero for the beginning of the loop, with entries 0
is.zero <- select(mutate(X,is.zero=0),-X)
X_min <- inner_join(X, is.zero, by=c("Sector","Country"))
  
  
iteration <- 1
delta <- 1e10
approach_factor <- 1e5
while(delta>tol && iteration<=1000 ){
  # adapt X to a good estimate
  X <- mutate(X_min, X= (1 -is.zero/1e6) * X)
  X <- select(X,-is.zero)
  
  # X2 is the material need for all countries and sectors
  X2 <- inner_join(dta,X,by=c("Sector","Dest_C"="Country"))
  X2_temp <- X2 %>%
    group_by(Source_C,Sector) %>%
    summarize(pitaux = sum(piprime_discounted*X)) 
  X2_temp <- inner_join(ioc,X2_temp, by=c("Country"="Source_C","Dest_S"="Sector"))
  X2_temp <- X2_temp %>%
    group_by(Country, Source_S) %>%
    summarize(material_need=sum(pitaux*Gamma_kjn)) %>%
    select(Country,Sector=Source_S,material_need)

  # X3 is alpha multiplied with the tariff revenue of the households
  X3 <- inner_join(dta,X, by=c("Sector","Dest_C"="Country"))
  X3_temp <- X3 %>%
    group_by(Dest_C) %>%
    summarize(tariff_revenues = sum(Tariffs2005/100 * X * piprime_discounted))
  X3_temp <- inner_join(X3,X3_temp,by=c("Source_C"="Dest_C"))
  X3_temp <- distinct(transmute(X3_temp, Country=Source_C, Sector=Sector, tariff_revenues=tariff_revenues*Alpha_Source))

  equation_a <- inner_join(X,X2_temp, b=c("Country", "Sector"))
  equation_b <- inner_join(X3_temp,rhs, b=c("Country", "Sector"))
  equation <- inner_join(equation_a,equation_b, b=c("Country", "Sector"))
  # 'is.zero' should be zero
  equation <- mutate(equation,is.zero = X - material_need - tariff_revenues - rhs)
  delta_new <- max(abs(equation$is.zero))
  is.zero <- select(equation,Sector,Country,is.zero)
  
  if(delta_new < delta){
    delta <- delta_new
    X_min <- X
    is.zero_min <- is.zero
    X_min <- inner_join(X_min, is.zero_min, by=c("Sector","Country"))
  }

  iteration <- iteration +1
}
```
#! end_note

<br>

## Exercise 3.4 -- Checking if the Trade Balance and Labour Market Clearing Hold - Equation 10

Until now, the parameters have been calculated such that equations **(6)-(9)** hold.  
However, if the whole equilibrium holds, it has to fulfil the trade balance, equation **(10)**:
$$\tag{10} \sum^J_{j=1}\sum^{N}_{i=1} \frac{{\pi^j_{ni}}^\prime}{1+{\tau^j_{ni}}^\prime} {X^j_n}^\prime - D_n = \sum^J_{j=1}\sum^{N}_{i=1} \frac{{\pi^j_{in}}^\prime}{1+{\tau^j_{in}}^\prime} {X^j_i}^\prime,$$
where ${I_n}^\prime=\hat{\mathsf{w}}_n\mathsf{w}_n L_n + \sum^J_{j=1}\sum^N_{i=1} {\tau^j_{ni}}^\prime \frac{{\pi^j_{ni}}^\prime}{1+{\tau^j_{ni}}^\prime} {X^j_n}^\prime +D_n$   
and
$\hat{\kappa}^j_{ni}=\frac{1+{\tau^j_{ni}}^\prime}{1+\tau^{j}_{ni}}.$

<br>

Note that CP do not actually check for this equation. Consider the following:  
Remember that equation **(5)** implies equation **(5')** in Exercise 2.5 c), namely labour market clearing, 
$$\tag{5'} \mathsf{w}_nL_n = \sum^J_{j=1} \gamma^j_n \sum^N_{i=1} \frac{X^j_{in}}{\tilde{\tau}^j_{in}}.$$

Analogously, equation **(10)** implies an equation **(10')**, assuming that available labour $L_n$ stays constant:
$$\tag{10'} {\mathsf{w}_n}^\prime L_n = \sum^J_{j=1} \gamma^j_n \sum^N_{i=1} \frac{{X^{j\prime}_{in}}}{{\tilde{\tau}}^{j\prime}_{in}}.$$

Now, we use this condition **(10')** to check whether the parameters we calculated so far are consistent with each other inside the model. In explicit, the condition of labour market clearing gives us wages at which there is full employment in the respective countries, a condition that is implied in our model and must hold. Note that the way the iteration is constructed, it is possible that the wages we calculate here do not correspond to the wages we guessed at the beginning of the whole iteration, before calculating equations **(6)** and **(7)**. If that is the case, we know that the equilibrium is not found yet and that we have to perform another iteration with new guesses of wages.

At the end of this exercise, there is a note where you can see the code for checking condition **(10')**, closing the loop and adapting the guess of wages if necessary. This is optional. Before, it is **your task** to answer the following quiz to recapitulate what you have learnt in this exercise.

#! addon__quiz__Exercise 3.4

<br>

This note is optional if you are interested in the code that closes the loop.

#! start_note "Note: Closing the loop"

```
w_temp <- inner_join(dta,x,by=c("Dest_C"="Country", "Sector"))
w_temp <- w_temp %>%
  group_by(Source_C,Sector) %>%
  summarize(vaxpidisc = sum(X*piprime_discounted*(VA_Source/100)/VA_Total_Source)) %>%
  group_by(Source_C) %>%
  summarize(wages_new = sum(vaxpidisc))
w_temp


# exports
  ex <- inner_join(dta,x, by=c("Sector","Dest_C"="Country"))
  ex <- ex %>%
    group_by(Source_C) %>%
    summarize(ex = sum(X*piprime_discounted))
  # imports
  im <- inner_join(dta,x, by=c("Sector","Dest_C"="Country"))
  im <- im %>%
    group_by(Dest_C) %>%
    summarize(im = sum(X*piprime_discounted))
  
  # check for closeness to target value (equality in Equation 10)
  superavit <- dta %>%
    select(Source_C,superavit=Superavit_Source,VA_Total_Source) %>%
    distinct() 
  error <- inner_join(inner_join(ex,im, by=c("Source_C"="Dest_C")), superavit, 
      by="Source_C")
  error <- mutate(error, error=ex-im-superavit)
  wfmax <- max(abs(error$error))
  print(cat("wfmax:",wfmax, "\n"))
  
  # adapt wages
  # no minus sign in front of error, already good
  error <- mutate(error, adaptation_step = error/VA_Total_Source) 
  wf1 <- inner_join(wf0,error, by=c("Country"="Source_C"))
  wf1 <- mutate(wf1, wages_next= wages*(1+0.4*adaptation_step/wages))
  wf0 <- select(wf1,Country, wages=wages_next)
```
#! end_note

<br>

## Exercise 3.5 -- Welfare Effects of Tariff Changes
In this exercise, we will see the welfare effects of our restricted model with two countries (Mexico, USA) and two sectors (textile and retail), after having found the equilibrium in relative changes as introduced in Exercises 3 to 3.4. The calculations follow equation **(11)** which will be introduced in Exercise 4. They return terms of trade and volume of trade effects on welfare, as well as aggregate welfare effects. 
Despite equation **(11)** being formally explained later, it is already used in this exercise since the corresponding code is lengthy, just like some other codes in this block of Exercises 3 to 3.5.

Since calculations are still lengthy, you are just given the results of the welfare calculations. The whole calculations of welfare effects due to tariff changes are presented in the note at the end of this exercise. **Your task** is simply to check the following code chunk.
```{r "3_5",signif.digits=6}
read.csv("welfare.csv")
```

<br>
In the second and third column appear the term of trade (ToT) and volume of trade (VoT) effects on welfare (see equation **(11)**). Aggregate welfare effects are given in percent in column four.  
What we can see is that, in our very restricted model with two countries and two sectors, both countries have a positive welfare effect. According to the simulation, Mexico would have benefitted from 0.4% of welfare increase due to free trade within NAFTA. The effect for the U.S. would have been 0.02%. These benefits stem almost completely from the welfare effect due to an increase in volumes of trade.   
At this point it is noteworthy, that, first, Piermartini and Teh (2005) point out that in CGE models not the exact figure of effects should be considered but rather the magnitude. Second, note that these small effects on welfare would stretch to a period of 12 years, as the model considers effects between 1993 and 2005. This translates to an effect in the magnitude of 0.03% per year in the case on Mexico and one twentieth of this effect for the case of the USA. Admittedly these results stem from only a very small model, for a discussion of the whole model's results see Exercises 4.1 and 4.2.

Consider that in CP's model, welfare is calculated as $W_n = \frac{I_n}{P_n}$, see Exercise 4. Hence the result of our restricted model is that, due to the NAFTA tariff reductions, the households' yearly income's purchasing power rose in an average magnitude of 0.03% in twelve consecutive years. 

<br>

The following note with the code for welfare calculation is only for the most interested users. You also may skip the remaining of this exercise.

#! start_note "Note: The code for welfare calculation"

This code builds on the whole equilibrium finding code in the note at the end of Exercise 3. It calculates terms of trade and volume of trade effects on welfare, as well as aggregate welfare effects. Calculations are consistent with the code of Exercises 3 to 3.4 and calculations have their origin in equation **(11)**. Consider for example, that `ToTEjn` stands for the exports part of the terms of trade effect, namely $\sum^N_{i=1} E^j_{ni} d \ln c^j_n$. As an anticipation the equation is presented here.

$$\tag{11} d \ln W_n = \frac{1}{I_n} \sum^J_{j=1} \sum^N_{i=1} \underbrace{\left( E^j_{ni} d \ln c^j_n - M^j_{ni} d \ln c^j_i \right)}_{ToT} + \frac{1}{I_n} \sum^J_{j=1} \sum^N_{i=1} \underbrace{\tau^j_{ni} M^j_{ni} \left( d \ln M^j_{ni} - d \ln c^j_i \right)}_{VoT}, $$
where **ToT** stands for the welfare effects due to **terms of trade** effects and **VoT** for the welfare effects due to **volume of trade** effects from tariff changes. 

See Exercise 4 and for more explanation.

```
Welfare <- inner_join(piprime,xprime,by=c("Sector", "Dest_C"="Country"))
Welfare <- Welfare %>%
  mutate(xbilattau_all=X*piprime_discounted) %>%
  mutate(xbilattau = (Expend_Dest*Expend_Shares/(1+Tariffs1993/100)) ) %>%
  mutate(xbilatp = xbilattau_all/xbilattau) %>% 
  mutate(xbtau = xbilattau*(Tariffs1993/100) ) 

  #in xbilattau: columns are source countries
Xjni <- inner_join(Welfare,cphat,by=c("Sector","Source_C"="Country"))
Xjni <- Xjni %>%
  mutate(Xjni=xbilattau*(cc-1)) %>%
  mutate(votXjni= xbtau*(xbilatp-1-cc+1))

ToTEjn <- Xjni  %>%
  group_by(Sector,Source_C) %>%
  summarize(ToTEjn=sum(Xjni))
ToTMjn <- Xjni   %>%
  group_by(Sector,Dest_C) %>%
  summarize(ToTMjn=sum(Xjni))
VoTXjn <- Xjni %>%
  group_by(Sector,Country=Dest_C) %>%
  summarize(VoTXjn=sum(votXjni, na.rm=TRUE))

ToT <- inner_join(ToTEjn,ToTMjn, by=c("Sector","Source_C"="Dest_C"))
ToT <- ToT %>%
  group_by(Country=Source_C) %>%
  summarise(ToT=sum(ToTEjn-ToTMjn))
ToT <- inner_join(ToT, income, by="Country")
ToT <- mutate(ToT,ToT=ToT/income)
ToT <- select(ToT, -income)

VoT <- inner_join(VoTXjn,income,by="Country")
VoT <- VoT %>%
  mutate(temp =VoTXjn/income) %>%
  group_by(Country) %>%
  summarize(VoT=sum(temp,na.rm=TRUE))

Welfare <- inner_join(ToT, VoT, by=c("Country"))
Welfare <- mutate(Welfare, Welfare=ToT+VoT)
Welfare
```

#! end_note


<br>

<br>


## Exercise 4 - The Model's Results

In this part of the RTutor problem set we will discuss CP's findings. Exercise 4 provides explications how CP measure trade and welfare effects of NAFTA, which arise from the equilibria they find with the model (Exercises 2 to 2.6) and with the calculations (Exercises 3 to 3.5) presented above.  
Exercise 4.1 presents results assuming only tariff reductions within the block of NAFTA members, while Exercise 4.2 shows the results given all the worldwide tariff changes which occurred between 1993 and 2005.

The way CP set up their model, they do not rely on trade data from 2005 and they do also not compare their results to what actually happened in the 12 years between 1993 and 2005, the years for which they performed their estimations.

<br>

#### a) Measuring Welfare Effects

In their work, CP denote the welfare of the representative consumer in country $n$ by $W_n = \frac{I_n}{P_n}$, namely the total income divided by the price index in country $n$. For more details about the components of the formula of welfare, see the following info box.

info("More on the welfare formula") # Run this line (Strg-Enter) to show info

<br>

With lengthy differentiating calculations using the equilibrium conditions, CP show that the following equation holds for the change in logarithmic welfare:
$$\tag{11} d \ln W_n = \frac{1}{I_n} \sum^J_{j=1} \sum^N_{i=1} \underbrace{\left( E^j_{ni} d \ln c^j_n - M^j_{ni} d \ln c^j_i \right)}_{ToT} + \frac{1}{I_n} \sum^J_{j=1} \sum^N_{i=1} \underbrace{\tau^j_{ni} M^j_{ni} \left( d \ln M^j_{ni} - d \ln c^j_i \right)}_{VoT}, $$
whereat **ToT** stands for the welfare effects due to **terms of trade** effects and **VoT** for the welfare effects due to **volume of trade** effects from tariff changes. 

**Terms of trade** are a measure of a country's export prices relative to its import prices, for example $\ln \frac{p_E}{p_M} = \ln p_E - \ln p_M$ for some exemplary price variables $p_E$ and $p_M$. It can be shown, that in CP's model changes in prices can be expressed directly by changes in input costs. For the relation between prices and costs see Exercise 2.3 c. As a consequence, if we give the change in import prices the weight of import values and analogously for export prices, we find that one way to express a weighted term of trade is 
$$E^j_{ni} d \ln c^j_n - M^j_{ni} d \ln c^j_i.$$
This is exactly one of the terms in equation **(11)** and the explanation why CP call the term **terms of trade effect of welfare changes**. See Exercise 2.5 c) for the definition of the export and import variables $E$ and $M$.

The **volume of trade** effects in equation **(11)** can be interpreted as follows: The right-hand side of the equation     
$$d \ln M^j_{ni} - d \ln c^j_i = d \left[ \ln M^j_{ni} - \ln c^j_i \right] = d \ln \left[\frac{M^j_{ni}}{c^j_i} \right]$$ 
represents the change in import values discounted by import prices. This is a measure of volume of trade change. The weight of this term, $\tau^j_{ni} M^j_{ni}$, represents the corresponding initial tariff revenue. As we can see from equation **(11)**, the volume of trade effect as described here has a positive effect on welfare changes.  

Welfare effects and the contribution of terms of trade and volume of trade effects will be evaluated in part a) in Exercises 4.1 and 4.2. Furthermore, as equation **(11)** shows, the welfare effects can be decomposed easily according to sectors, which is what we will do in part b) in Exercise 4.1.

<br>

#### b) Trade Effects and Wages

Effects on trade that arise from tariff reductions are simply measured by changes in the volume of imports. They are evaluated in part c) in Exercises 4.1 and 4.2.

Using equations **(6)** and **(8)**, CP solve for the change in real wages in each sector and aggregating across sectors yields the following equation
$$\tag{12} \ln \frac{\hat{\mathsf{w}}_n}{\hat{P}_n} = - \sum^J_{j=1} \frac{\alpha^j_n}{\theta^j} \ln \hat{\pi}^j_{nn} - \sum^J_{j=1} \frac{\alpha^j_n}{\theta^j} \frac{1-\gamma^j_n}{\gamma^j_n} \ln \hat{\pi}^j_{nn} - \sum^J_{j=1}\frac{\alpha^j_n}{\gamma^j_n} \ln \prod^J_{k=1} \left( \frac{\hat{P}^k_n}{\hat{P}^j_n} \right)^{\gamma^{kj}_n}. $$

Note that in equation **(12)**, we do not use the differentiation operator $d$, since the variables' 'hats' already indicate a change. Namely, $\frac{\hat{\mathsf{w}}_n}{\hat{P}_n}$ stands for the change in wages divided by the change in prices, see Exercise 2.6.


For an example of how to implement the welfare effects' calculations in `R`, refer to Exercise 3.5.

<br>

#### c) Robustness of the Estimates

CP perform their calculations with two basic set-ups: First, setting trade deficits to zero for all the countries and second, allowing for trade deficits. They find that all their results are robust to both of the model set-ups. Therefore, we will only consider the no-deficit case here, which is also CP's main analysis.

Additionally, CP compare the results of their main model with different simplifying models. They find that all the simpler models lead to significantly lower results. As a conclusion, they state that it is important to account for input-output linkages, several sectors and intermediate goods in production. All these model features lead to stronger results. Hence CP judge them to be more adequate for the evaluation of trade and welfare effects from tariff changes.


<br>

## Exercise 4.1 -- Effects from NAFTA Tariff Reductions


Within this Exercise 4.1, the results are calculated considering only NAFTA tariff reductions, while the tariffs from and to non-NAFTA countries are assumed to stay at their 1993 level.

<br>

#### a) Welfare and Wage Effects

**Your task** is to check the following code chunk, which exhibits the welfare and real wages effects for the NAFTA members. 

```{r "4_1",signif.digits=3}
welfare_nafta <- read.csv("welfare_nafta.csv")
welfare_nafta
```

The data frame `welfare_nafta` shows total welfare effects in the second column, its components terms of trade and volume of trade effects in the third and fourth column and changes in real wages in the fifth column. As we can see, only in the case of Mexico the model returns significant results. Both the welfare and the real wages increase by more than 1% due to the NAFTA tariff reductions. In the case of Canada and the USA, all effects are far lower than 1%. Since the effects additionally spread over the period between 1993 and 2005, they can be considered as rather low. The Mexican results translate to 0.1% of annual welfare growth due to NAFTA.  
Remember that Piermartini and Teh (2005) point out that in CGE models, instead of the exact figure of effects rather the magnitude should be considered. CP argue that NAFTA had more effects on trade than only reducing tariffs and that their results should by no means be interpreted as NAFTA's whole effects on trade and welfare.

Note that both for Mexico and for Canada, the welfare effects due to terms of trade effects are negative, whereas for all three countries the effects due to volume of trade changes are positive and important.

<br>

The following code chunk shows the welfare effects of the whole sample of countries, not only NAFTA members, still under the assumption of no tariff changes outside NAFTA. **Your task** is to check the chunk.

```{r "4_1__2",signif.digits=3}
world_welfare_nafta <- read.csv("world_welfare_nafta.csv")
head(arrange(world_welfare_nafta, desc(Total)))
tail(arrange(world_welfare_nafta, desc(Total)))
```
Here, we can see the welfare effects for the countries that benefitted most and least from NAFTA tariff changes. One can see that the NAFTA member countries show the most extreme outcomes. This is not surprising because the tariff changes we analyse here only affect the NAFTA members directly. Still, due to the interdependency of sectors and states, all the countries are affected. Under the assumption of tariff reductions within NAFTA but no tariff reductions for exporters outside NAFTA, some imports that originally stemmed from countries outside NAFTA were deviated to exporters inside NAFTA. Moreover, CP point out that the NAFTA tariff reductions actually really created trade, not just diverted trade flows that formerly existed. An interesting finding is, however, that there are non-NAFTA countries which actually benefit from the tariff reductions both by terms of trade and by volume of trade effects, contrary to the trade flow diverting effect.


<br>

#### b) Sectoral Contribution

With the decomposition of welfare effects in equation **(11)**, it is possible to evaluate the terms of trade and volume of trade effects on a sectoral basis. The following chunk presents sectoral contributions to the welfare effects we inspected in the code chunk above. **Your task** is to check the code.

```{r "4_1__3",signif.digits=3}
sectoral_contribution_nafta <- read.csv("sectoral_contribution_nafta.csv")
arrange(sectoral_contribution_nafta, 
        desc(ToT_Mexico+VoT_Mexico+ToT_Canada+VoT_Canada+ToT_USA+VoT_USA))
```
Note that the command `arrange(sectoral_contribution_nafta, ... )` gives the data frame `sectoral_contribution_nafta` in an ordered way: `desc(ToT_Mexico + ... )` says that for every row the sum of `ToT_Mexico + .... ` is calculated and that the rows are ordered in descending order according to the sums' values. Note further that every column sums up to 100. This means that the data frame gives for each sector, to which share it contributes to the terms of trade effects or volume of trade effects on welfare changes. Here it is important to emphasize that, for the case of Mexican and Canadian terms of trade effects, this means a contribution to a decrease in welfare, as we saw in the first chunk in part a).  
It is remarkable that for all countries only few sectors contribute largely to welfare effects. See for example the first row: The electrical sector has a large positive influence on welfare through volume of trade effects both in Mexico and in the USA. This is because of the strong linkages between Mexican and U.S. economies and the cross-border value chains. Note that according to the ISIC of the United Nations (2016), the electrical sector does stand for electrical machinery and apparatus. It does not represent electricity, gas or water supply, which is one of the non-tradable sectors CP consider.  
Furthermore, the electrical sector also contributes to a big extent to the terms of trade effect on Mexican welfare decrease and on U.S. welfare increase. Remember that **terms of trade** are a measure of a country's export prices relative to its import prices, see Exercise 4 a). Hence the easy explanation of the finding is as follows: When Mexican export prices fall, on the one hand Mexican terms of trade deteriorate, while on the other hand U.S. terms of trade rise. Because of the strong trade flow from Mexico to the USA, this effect is notably pronounced. 
At that point, it is an interesting question why this occurs in particular in the electrical sector and to some extent in the automobile and textile sectors. One reason for this are the pre-NAFTA levels of tariffs: The more the tariffs fall, the more effects can be observed. Also the level of trade in the sector plays an important role. Finally, the degree of sectoral linkages via input-output coefficients and the material need explain a good part of the observations.
Let us see what CP state on the volume of trade effects on welfare:

> "Only a handful of sectors were responsible for the aggregate volume of trade effects. These were sectors highly protected before NAFTA, like Textiles in Mexico, with a large trade elasticity, like Petroleum, and with a large share of material use and sectoral interdependence, like Electrical Machinery and Autos."

> *Source: CP, p.3*

<br>

#### c) Trade Effects


The following chunk presents trade effects that arise from NAFTA tariff reductions. Here again, only NAFTA members' imports from other NAFTA members are what we focus on. Checking the chunk is **your task**. 


```{r "4_1__4",signif.digits=3}
trade_nafta <- read.csv("trade_nafta.csv")
trade_nafta
```
Note that the first row represents Mexico's imports, the second row Canada's and the third row USA's.  
We can observe that in particular trade flows from and to Mexico increase enormously. Only Canada's imports from Mexico did not at least double as they rose by 60%. CP state that Mexico became an important supplier of materials due to NAFTA agreement and that trade relations between the three countries strengthened.   
Trade flows between Canada and the USA did only increase by 7% to 9%. The reason for this is that Canada and the USA already signed a bilateral free trade agreement in 1987. Presumably, both countries grew together to a large extent already in the course of this pre-NAFTA free trade agreement.

<br>
**Your task** now is to solve the following quiz with the help of the free code chunk.
```{r "4_1__5"}
# Enter code freely here
```

#! addon__quiz__Exercise 4.1

<br>

## Exercise 4.2 -- Effects from World Tariff Reductions

In this Exercise 4.2, we consider all the tariff changes that occurred between 1993 and 2005. CP state that more than 100 regional trade agreements came into effect in that period of time while there were also few tariff increases.


#### a) Welfare and Wage Effects

**Your task** is to check the following code chunk, which presents the welfare effects of the NAFTA members after world's tariff changes.

```{r "4_2",signif.digits=3}
nafta_welfare_world <- read.csv("nafta_welfare_world.csv")
nafta_welfare_world
```
Comparing the welfare and wages effects here with the effects we saw in Exercise 4.1 a), we see that the figures are very similar, only slightly smaller in absolute values. So the calculations seem to be robust for the NAFTA countries and the magnitude is underpinned.  
Note how the values are calculated by CP: First, they calculate the effects of all the worldwide tariff changes, excluding the NAFTA tariff changes. In a second step, they calculate the effects of all tariff changes, including NAFTA tariff changes. The data frame `nafta_welfare_world` shows the welfare and wages differences between the two calculations, or simply the NAFTA effects given non-NAFTA tariff changes. 


<br>

The following code chunk shows the welfare effects for all the countries in the sample due to all tariff changes between 1993 and 2005, including NAFTA. Checking it is **your task**.

```{r "4_2__2",signif.digits=3}
world_welfare_world <- read.csv("world_welfare_world.csv")
world_welfare_world
```
Probably the most outstanding result is that every single country in our sample wins in terms of welfare from world tariff reductions. Also, every single country's volume of trade contribution to welfare is positive, too.  
The countries who benefitted most are China and Portugal, having different reasons for their welfare increase. China owes its gains especially the volume of trade effects. CP write that an increase of more than 13% in welfare is due to other countries reducing import tariffs on Chinese products. Portugal's welfare gain in contrast stems mainly from the terms of trade effect.
Another particular result that arises from the two code chunks in part a) is, that Canada too benefits from all the tariff reductions. Still, it would have benefitted even more without NAFTA tariff reductions.

In the following chunk, **your task** is to calculate the three columns' averages with the function `summarize_each()`. The parameter `vars=-Countries` tells the function to execute the calculation - which we indicate with the expression `mean` in `funs(mean)` - over each of the columns, excluding the column `Countries`.
```{r "4_2__3",signif.digits=3}
summarize_each(world_welfare_world,funs(mean), vars=-Countries)
```
As we can see from this calculation, the worldwide tariff reductions between 1993 and 2005 lead to a notable increase in welfare, 1.6% on average. The biggest part of this welfare increase stems from the volume of trade effects on welfare.

<br>

#### b) Sectoral Composition of Exports

**Your task** is to check the following code, which shows a sectoral decomposition of exports from NAFTA countries, before and after the global tariff changes came into force.
```{r "4_2__4",signif.digits=3}
nafta_sectors_world <- read.csv("nafta_sectors_world.csv")
nafta_sectors_world
```
This data frame exhibits the percentages of sectoral contribution to a country's exports, both before and after NAFTA. You can already see that each country has different sets of key exporting sectors. The automotive sector is important for all of the three countries, having an export share of at least 8%. To be able to create a meaningful plot about concentration of export activity, let us modify the data frame a little.
 
In the following code chunk, we will convert the data frame `nafta_sectors_world` to long format, with the name `sectors_long`. We perform this conversion in order to be able to plot nicely all the columns of `nafta_sectors_world` with the `ggplot()` command `factet_grid()`. If you want to see how `sectors_long` looks like, press the `data` button at the top of a code chunk or use the free code chunk at the end of this exercise. You can thereby figure out what kind of rearrangement the command `melt()` does, just compare the data frame `sectors_long` with `nafta_sectors_world`. 
**Your task** is to check the code.
```{r "4_2__5",fig.width=12, fig.height=9}
sectors_long <- melt(nafta_sectors_world, 
                     id.vars="Sectors", variable.name="Country_Time")
ggplot(sectors_long, aes(x=value)) + 
  geom_histogram(binwidth=0.1) + 
  facet_grid(Country_Time~.)
```
In this set of histograms, 'value' stands for the export share and 'count' stands for the frequency. We can see that a big part of Mexico's total exports before NAFTA was concentrated on few sectors with more than 15% of total exports each. With the help of the preceding code chunk we can identify the sectors as Electrical, Auto and Mining. Note again that according to the ISIC of the United Nations (2016), CP denote as 'Electrical' the manufacturing tradable sector, while 'Electricity' stands for the non-tradable energy supplying sector.  
Canada had a strong auto sector with 24% export share while the USA had no sector which accounted for more than 11% of exports. According to the graphs, a result of NAFTA was that Mexico's concentration rose especially in the case of the electrical sector where its export share rose from one fifth to one third. Canada and the USA in contrast rather became more diversified. 

If you want to figure out what kind of rearrangement the command `melt()` does, check the following optional code chunk. That way you can see how the data frame `sectors_long` looks like and compare it with `nafta_sectors_world`, out of which it is created. Otherwise continue with part c).
```{r "4_2__6",optional=TRUE, signif.digits=3}
sectors_long
```

<br>

#### c) Trade Effects


The following chunk presents trade effects that arise from world's tariff reductions. We focus on NAFTA members' imports from other NAFTA members. **Your task** is to check the code chunk.

```{r "4_2__7",signif.digits=3}
nafta_imports_world <- read.csv("nafta_imports_world.csv")
nafta_imports_world
```
Note again, that the first row represents Mexico's imports, the second row Canada's and the third row USA's. In the case of imports, too, the effects of all the worldwide tariff changes are very similar to the effects of only NAFTA tariff reductions, confer Exercise 4.1 c). So the three NAFTA countries seem to have such strong trade relations that the tariffs between them play a much bigger role than the tariffs between non-NAFTA countries. Even the tariff reductions of Mexico for example with non-NAFTA countries did not play a big role, despite Mexico entering several free trade agreements between 1993 and 2005. This finding is in line with real data, as the USA is by far Mexico's most important trade partner. Similar effects can be observed for Canada and the USA, even though their trade flows are not focused as much on NAFTA members as Mexico's are.

<br>

Now, finally **your task** is to use this free code chunk in order to solve the following quiz.
```{r "4_2__8"}
# you may enter code freely here
```

#! addon__quiz__Exercise 4.2


<br>

<br>


## Exercise 5 - Trade Elasticities 
In CP, sectoral trade elasticities $\theta^j$ (also called the Thetas) are the only parameters necessary for the model which cannot be obtained via direct calculation. These parameters thus need to be estimated in order to identify the effects of tariff reductions.  
Trade elasticities are also employed as a parameter for the Frechet distribution and they stand for **dispersion of productivity**, a notion of **comparative advantage**. That means that they determine how changes in tariffs affect trade flows, which in turn explains their name. 

Exercises 5 and 5.1 are not crucial for the core of this RTutor problem set while at least Exercise 5 is pretty interesting for getting a notion of the dynamics of the core parameters $\theta^j$.

<br>

#### A Visualization of the Effect of Tariff Changes According to the Trade Elasticities $\theta^j$

In the following of this exercise, let us perform a small sensitivity analysis of the expenditure share reaction on a change in tariffs. Under some simplifications, we can calculate expenditure shares without having to know all of the other parameters of the whole model. Some parameters are neither calculated in CP, recall Exercise 2.6. So we simplify in order to be able to calculate expenditure shares at all and still the magnitudes of the results should be reasonable. If you want to see how the simplification works, see the note "The construction of the Theta calculation example" below.

Let us, as an example, keep Canada as destination country fixed, take the chemical sector and calculate the expenditure shares of all countries in the Canadian market in a first step.  
In a second step lower the Canadian tariffs on imports from the USA (ceterus paribus) to get the new hypothetical expenditure shares. Note that lowering the tariffs by $10\%$ means a multiplication of tariffs by $0.9$. **Your task** is to execute the self-written function `trade_elasticities()` in the following code chunk, so that you can see what comes out from these assumptions.


```{r "5___Trade_Elasticiti"}
trade <- read.csv("trade.csv")
trade_elasticities(dest="Canada", sect="Chemicals", sour="USA", 
                   percentage_change = -10, trade=trade)
```

Note that the chemical sector has pretty low trade elasticities.   
Now compare this sector's results to the petroleum sector, which has the highest trade elasticity. **Your task** is to call the function `trade_elasticities()` similarly as above, simply using the sector `Petroleum` instead.

```{r "5___Trade_Elasticiti__2"}
## enter your command here
```




Comparing the results for a tariff reduction by 10% in the chemical and petroleum sectors, you can solve the following quiz, which is **your task**.






#! addon__quiz__Sensitivity of expenditure shares to Theta

<br> 

Additionally, let us have a quick look on what the inventors of the model, on which CP base their work, write about their parameter $\theta$: 

> "As the force of comparative advantage weakens (reflected by a higher Theta), normalized import shares become more elastic with respect to the average relative price and to geographic barriers. A higher value of Theta means relative efficiencies are more similar across goods. Hence there are fewer efficiency outliers that overcome differences in average prices or geographic barriers." 

> *Source: EK, p. 1751*

So we learned how trade elasticities work conceptually. A higher trade elasticity leads in general to a stronger reaction on tariff changes. Here is another small quiz to recapitulate some characteristics of $\theta^j$ as **your task**.

#! addon__quiz__EK and Theta


<br>

If you want to see in detail which simplifications and analytics are made for the function `trade_elasticities` in order to calculate the above example, see the following note.

#! start_note "Note: The construction of the Theta calculation example"

Recall equation **(3)**:
$$\pi^j_{ni} = \frac{\lambda^j_i \left[ c^j_i \kappa^j_{ni} \right]^{-\theta^j}}{\sum^N_{h=1} \lambda^j_h \left[ c^j_h \kappa^j_{nh} \right]^{-\theta^j}},$$
where $\pi^j_{ni}$ is the expenditure share in country $n$ on sector $j$ goods from country $i$. It can also be represented as $\pi^j_{ni}= \frac{X^j_{ni}}{X^j_n}$.  
From these equations we cannot directly say that $X^j_{ni}=\lambda^j_i {c^j_i}^{-\theta^j} {\kappa^j_{ni}}^{-\theta^j}$ and that $X^j_{n}=\sum^N_{h=1}\lambda^j_h {c^j_h}^{-\theta^j} {\kappa^j_{nh}}^{-\theta^j}$. However, assuming strictly positive expenditure shares, we know that there must be an $s$ such that:
$$X^j_{ni}=s \cdot \lambda^j_i {c^j_i}^{-\theta^j} {\kappa^j_{ni}}^{-\theta^j} \Longleftrightarrow X^j_{n}=s \cdot \sum^N_{h=1}\lambda^j_h {c^j_h}^{-\theta^j} {\kappa^j_{nh}}^{-\theta^j}.$$

Substituting $S^j_i:= s \lambda^j_i {c^j_i}^{-\theta^j}$ we can write
$$X^j_{ni} = S^j_i {\kappa^j_{ni}}^{-\theta^j} \hspace{5mm} \mathsf{and}  \hspace{5mm} X^j_n = \sum^N_{h=1} S^j_h {\kappa^j_{nh}}^{-\theta^j}.$$

Since we can easily calculate the $X^j_{ni}$ and $X^j_n$ and if we take $\tilde{\tau}^j_{ni}$ as a proxy for $\kappa^j_{ni}$, we can do a small sensitivity analysis of the expenditure share reaction on a change in tariffs.

#! end_note

<br>

Exercise 5.1 is designed for the reader who is interested in some more technical background. It is not essential for the understanding of the whole RTutor problem set.


<br>


## Exercise 5.1 -- Visualization of $\theta^j$ (Theta)
This is an optional exercise, meaning that you can skip it if you are only interested in the most important parts of this RTutor problem set.

In part a) you can learn how the $\theta^j$ are estimated in CP and for this problem set. Furthermore, in part b) you can find an explanation why this parameter is called 'elasticity'. Part c) addresses a slight issue about the interpretation of the Thetas.

<br>

#### a) Estimating the Thetas


In order to estimate the $\theta^j$ for their model with the need of as little parameters as possible, CP find the equation
$$\tag{13} \ln \left( \frac{X^j_{ni} X^j_{ih} X^j_{hn}}{X^j_{in} X^j_{hi} X^j_{nh}} \right ) = - \theta^j \ln \left( \frac{\tilde{\tau}^j_{ni} \tilde{\tau}^j_{ih} \tilde{\tau}^j_{hn}}{\tilde{\tau}^j_{in} \tilde{\tau}^j_{hi} \tilde{\tau}^j_{nh}} \right ) + \tilde{\epsilon}^j, $$
with expenditures $X^j_{ni}$, tariffs $\tilde{\tau}^j_{ni}=1+\tau^j_{ni}$ and the error term $\tilde{\epsilon}^j$.

The left-hand side can be interpreted as the cross-product of shipping one sector's goods in a circle consisting of countries $n$, $i$ and $h$ in one direction, divided by the cross-product of shipping the same goods in the other direction in the same circle. Using equation **(3)** and the properties of variables implied, the right-hand side is obtained. The virtue of equation **(13)** in estimating the Thetas is that they can be estimated directly without needing to make assumptions for other variables since they cancel out. The only assumption CP need to make is that the $\tilde{\epsilon}^j$ are orthogonal to tariffs.  


In order to estimate the Thetas here, first it is **your task** to read in the data we need.
```{r "5_1"}
data_thetas <- read.csv("data_thetas.csv")
data_thetas_99 <- read.csv("data_thetas_99.csv")
trade <- read.csv("trade.csv")
```


The function `get_thetas()`, which is based very much on the standard `R` function `lm()`, calculates the coefficient of the term 
$$\ln \left( \frac{\tilde{\tau}^j_{ni} \tilde{\tau}^j_{ih} \tilde{\tau}^j_{hn}}{\tilde{\tau}^j_{in} \tilde{\tau}^j_{hi} \tilde{\tau}^j_{nh}} \right )$$ 
via ordinary least squares regression.  
**Your task** is it to check the following chunk, where the regression is performed. The example sector is agriculture.
```{r "5_1__2"}
get_thetas(data_thetas_99,Sectors="Agriculture")
```
The outputs of this self-written function are $\theta^j$, the sector $j$ for which it is calculated and `DOF`. `DOF` stands for 'degrees of freedom', which is the number of x-y pairs, the observations in the regression, minus the number of constraints in the regression. Here, we have one constraint, so the number of complete observations without missing or infinite values in the respective sector equals $\mathsf{DOF}+1$.


As a further step, **your task** is to retrieve $\theta^j$ from the data frame `trade` with the data that CP provide. The example sector is agriculture.
```{r "5_1__3"}
#trade %>%
#  ??? (Sector,Trade_Elast) %>%
#  ???(Sector=="Agriculture") %>%
#  distinct()  # With this command you choose only one of the 30 identical rows.

```
Comparing the results of the two last chunks, we see that we can reproduce CP's output.

Now let us have a little closer look on the regression by plotting it for the petroleum sector and giving out the brief values as above. Checking the following chunk is **your task**.
```{r "5_1__4"}
# first plot: petroleum
print_thetas(data_thetas_99, Sectors="Petroleum")
get_thetas(data_thetas_99, Sectors="Petroleum")
```
Note that the slope of the regression line in the graph is negative while Theta is positive, as it is for all sectors. This is because the slope is the whole coefficient of the regression while $\theta^j$ is the negative of the coefficient. This results from equation **(13)**.

<br>

After filtering the data for this RTutor problem set, there is one data point too much in the sector communication, in comparison to CP.
CP remove an outlier which does not really seem consistent. The value which is removed was the lowest x-value in the communication sector, namely -0.311054. Now the lowest x-value in the communication sector is -0.291915 which is not too far away considering that the maximum x-value, for which there has not been any removal, is 0.4010428. Furthermore, this value was only removed for the calculation of the 99% sample, not for the full sample. The removal of the Chinese data in the chemistry industry took place for both the full and the 99% sample. So the process of removing this single data point seems a somewhat arbitrary.

CP consider their estimates to be robust and to lie in the range of typical estimates in the literature. Furthermore, they compare estimation results of the 100% sample, the sample of data points which stand for 99% of trade flows and the sample which stands for 97.5% of trade flows. After realizing that three manufacturing sectors are not robust to the differing samples, they replace their estimates by the mean estimate for the manufacturing sectors. For more information on the additional robustness check they performed, see directly CP p. 17f and their appendix.

<br>

**Your task:** Solve this small quiz on $\theta^j$. The first question is: What is $\theta^j$ for $j=$ Agriculture?

#! addon__quiz__Estimating Theta

<br>


#! start_note "Note: More about the functions 'get_theta' and 'print_theta'"
In this note, you can perform some estimations of the respective $\theta^j$ and print some plots of the regressions. Just use the functions `print_thetas()` and `get_thetas()` as above, indicating the sector. If you want to use all sectors, write `NULL` instead.  
Furthermore, here you can also see the code of the function `get_thetas()`, which is generally not available in `R`. Is was especially created for this RTutor problem set. Just edit the chunk above and enter `get_thetas` to view the function code. It is important to leave out the `()` at the end.
```{r "5_1__5",optional=TRUE, points=0}
# Enter code freely here
```
The most important part of the code of `get_thetas()` is the call of the function `lm()` which does the ordinary least square (OLS) estimation. The line `Data <- Data[complete.cases(Data),]` makes sure that only rows within the data frame `Data` where there is no `NA`, are kept.

#! end_note

<br>

#### b) The Elasticity Characteristic of $\theta^j$

EK show in their equation (12) a representation of **country $i$'s normalized import share in country $n$**. That is the expenditure of country $n$ on country $i$ goods divided by the market share of country $i$ on its own domestic market. Despite CP not explicitly mentioning this equation, it is possible to show also in the context of CP's model, that 
$$\frac{\frac{X^j_{ni}}{X^j_n}}{\frac{X^j_{ii}}{X^j_i}} = \left( \frac{p^j_i}{p^j_n} \kappa^j_{ni} \right)^{-\theta^j},$$
which is the equivalent of equation (12) in EK. Here, $p^j_n$ is the price index for sector $j$ goods in country $n$.

Consequently,
$$\ln \left( \frac{\frac{X^j_{ni}}{X^j_n}}{\frac{X^j_{ii}}{X^j_i}} \right) = -\theta^j \left[ \ln(p^j_i) -\ln(p^j_n) +\ln(\kappa^j_{ni})  \right].$$

>"As this expression makes clear, Theta controls how a change in the bilateral trade costs [...] will change bilateral trade between two countries. This elasticity is important because if one wants to understand how a bilateral trade agreement will impact aggregate trade or to simply understand the magnitude of the trade friction between two countries, then a stand on this elasticity is necessary. This is what we mean by the elasticity of trade."

> *Source: Simonovska and Waugh (2014), p.36*


Another interpretation for $\theta$ arises from equation **(8)** for the change in expenditure shares in our model, where we have
$$\tag{8} \hat{\pi}^j_{ni}=\left[ \frac{\hat{c}^j_i \hat{\kappa}^j_{ni}}{\hat{P}^j_n} \right]^{-\theta^j}.$$

Recall that for any variable $x$, $x^\prime$ stands for the value in the new state and $\hat{x}=\frac{x^\prime}{x}$ is the relative change from the old to the new state.  
Now taking the logarithm of the change of expenditure shares 
$$\ln\left( \hat{\pi}^j_{ni}\right)=-\theta^j \ln\left[ \frac{\hat{c}^j_i \hat{\kappa}^j_{ni}}{\hat{P}^j_n} \right] = -\theta^j \left[ \ln\left(\frac{{c^j_i}^\prime}{c^j_i}\right) + \ln\left(\frac{1+{\tau^j_{ni}}^\prime}{1+\tau^j_{ni}}\right) -\ln\left(\frac{{P^j_n}^\prime}{P^j_n}\right) \right],$$
we see another justification why the $\theta^j$ are called **trade elasticities**: They determine to what extent the change in trade shares do react on changes in tariffs, prices or costs. 

<br>

#### c) An Issue about the Interpretation of the Thetas


In Exercise 5 we find that that a higher value of $\theta^j$ implies a higher sensitivity of expenditure shares on changes in prices and tariffs. Both our sensitivity example of trade shares depending on trade elasticities and the direct quote of EK state suggest.  
Contrary to this, CP state the contrary causal relation to be holding, as the following quote shows:

> "If productivity is less dispersed, as indicated by a larger value of Theta, then a change in tariffs will not change the share of traded goods in a substantial way. The reason is that goods are less substitutable. On the other hand, if the productivities are less concentrated - if there is high dispersion - small changes in tariffs can translate to large adjustments in the share of goods traded. The reason is that producers of the composite aggregate are more likely to change their suppliers, since goods are more substitutable."

> *Source: CP, p. 15f*

However, since CP base their model on EK's model, both CP and EK use their Thetas in the same way. Their Thetas are non-negative parameters of the Frechet distribution for production technology. Furthermore its usage in equation **(3)** respectively its equivalent in EK is identical. This means that one of the explications should be erroneous. In fact, CP somewhat indirectly contradict their above statement by the following quote:

> "Only a handful of sectors were responsible for the aggregate volume of trade effects. These were sectors [...] with a large trade elasticity, like Petroleum [...]." 

> *Source: CP, p.3*

This quote implies that, among others, in particular the sectors with high $\theta^j$ account for changes of trade flows due to tariff changes. This is in line with what we calculated exemplarily in Exercise 5 and it is in line with EK's interpretation.




<br>

<br>



## Exercise 6 - Conclusion, Related Literature and TTIP

In this exercise we will conclude CP's findings and relate them to other literature. NAFTA has evoked large controversy discussions and so do negotiations on possible future free trade agreements. Nevertheless, free trade agreements like NAFTA do not only concern actual free trade, they are also about protection of investments and lowering regulatory obstacles for trade. In part c) of this exercise, we discuss literature concerning the Transatlantic Trade and Investment Partnership (TTIP), leading to a final conclusion of this RTutor problem set in part d).

<br>

#### a) A Summary to CP's Findings
When it comes to summarizing CP's results, we can say that they find low to moderate results in wages and welfare effects. Their trade flow change estimates in contrast are considerable. However, what we have to keep in mind is that CP's focus is rather showing that a model like theirs is feasible, than attaching importance to their results. They also suggest that intermediate goods, sectoral linkages and heterogeneous sectors matter for free trade analyses.

Another characteristics of CP's methodology is, that with the exception of 2005 tariffs, they only employ data from 1993. This reduces the number of required variables and thus possible estimation errors on the one hand. On the other hand they do not show that their model actually fits the real world data and they do not address the ex-post verification issue Piermartini and Teh (2005) express.
In the following, we will conduct a brief comparison of the trade flow impact CP calculate with **real world trade flow evolution**.  


According to Banco de Mexico (2016), in 2005, Mexico exported goods with a total value of 183.6 billion dollars to the USA and imported goods with the total value of 118.6 billion dollars from the USA. Exports and imports to and from Canada amounted to 4.2 billion dollars and 6.2 billion dollars, respectively.
The United States Census Bureau (2016) provides data for goods trade flows between Canada and the USA in 2005: Canada's imported goods amounted to 211.9 billion dollars, while it exported 290.4 billion dollars, from and to the USA respectively. All these amounts are given on a nominal basis. In order to calculate these trade flows' amounts in real values, we employ the Historical Consumer Price Index for All Urban Consumers, which the Bureau of Labor Statistics (2016) provides. For December 1993 we find an index of 145.8, while 196.8 is the corresponding index for December 2005. With the help of these values stated here, together with the trade volumes `Trade_Vol` in the data frame `trade` which CP provide, a data frame `nafta_realtrade` is prepared for you. **Your task** is to read in the data frame and have a look on it.

```{r "6___Conclusion__Rela",signif.digits=6}
nafta_realtrade <- read.csv("nafta_realtrade.csv")
nafta_realtrade
```
The column `Total_Tradeflow` gives the total trade flows from `Source_C` to `Dest_C` in 1993, as CP give them in their data. In the column `Trade_2005_Nominal` the total trade flows from the source country to the destination country are given nominally as in 2005. In `Trade_2005_Real`, the total trade flows from the source country to the destination country are given in real values in constant 1993 billion dollars. The column `Percentage_Change` gives the percentage change in real values from 1993 to 2005.
Compare the real percentage changes to the percentage changes that CP calculate for all global tariff changes between 1993 and 2005, visible in the column `Changes_CP`. In Exercise 4.2 c) we already saw these changes as CP calculate them.  

What we can see from this data frame for the development of real value trade volumes between 1993 and in 2005 is fourfold:  
First, the trade volumes increased significantly for all country pairs in both imports and exports. Second, on average the percentage changes were much higher than in CP's analysis. Note in this context, that CP themselves state that in no way their model captures all effect that occurred in the course of NAFTA. They only consider tariff changes while the free trade agreement comprises many more effects than mere tariff reductions. Third, the trade effects between Canada and the USA are much higher than in CP's analysis. Possibly, some of the changes measured between 1993 and 2005 were still due to the free trade agreement between Canada and the USA, which came into force in 1988. On the other hand, what is a fourth observation in the data frame, the deviation between the effects which CP analyse and which actually occurred, has no clear pattern. On the one hand, Mexican exports to Canada only slightly rose by less than 13%, which is far less than CP measure. On the other hand, all the other trade flows at least almost doubled, or even quintupled, which in the majority of cases is far more than CP measure.
Together, these findings seem to underline Piermartini and Teh (2005) writing that a CGE model's outcome should only be considered in magnitude. Also, they support CP who say that NAFTA's effects are not limited to tariff reductions and that their model rather serves as example for the feasibility of such models than as an analysis of all NAFTA's effects.








<br>

#### b) Other Literature on the Topic of Free Trade


Romalis (2007) also evaluates effects from NAFTA, using trade and tariff data with similar aims as CP. He finds that until 2000 there was a welfare effect of -0.3% of GDP for Mexico and 0.00% or 0.01% for Canada and the USA, respectively. Bilateral trade volume changes inside the NAFTA block are all estimated in a range of -0.6% and 27.5% in real values. Hence, his findings are significantly lower than CP's. Despite keeping in mind that his evaluation concerns effects from 1994 only until 2000, five years less than CP, obviously both trade and welfare effects are significantly lower in his analysis. 

<br>

When it comes to another interesting field of studying trade agreements, namely a **social impact analysis** on the distribution of welfare or wages, there is no statement from CP. Their model nests the assumption of full employment of the workforce. Moreover, wages do not adapt as easily to changes as CP assume them to do. Hence, their calculation of wage effects allows only for a rough interpretation of total labour income, not for its distribution to more or less skilled workers or even for employment rates or poverty.
On the other hand, CP assign sector-specific shares of final output value to labour, so that their model grasps indirectly through their notion of wages how production shifts affect the labour share in total production.

Hanson (2003) states that, on the one hand Mexican industries where less skills are needed have suffered from tariff reductions through declines in wages and employment. This results from the relatively high tariffs in these industries before NAFTA and the subsequent strong reduction during NAFTA. On the other hand, the part of foreign direct investments which improved technology in manufacturing industries, led to a relatively higher demand for skilled labour. This means, wage inequality rose due to NAFTA. Furthermore, he states that wages in Mexican states next to the U.S. border rose relatively to other states more distant to the U.S. border. This is a consequence of the USA being by far the most important Mexican trading partner.  
Nicita (2006) comes to this last result, too. He additionally points out an important requirement for a further positive welfare effect for Mexican households. According to him, trade liberalization should be accompanied by an additional action plan for improved price transmission, as well as by productivity enhancing policies. Only with accompanying policies, such that the rural areas in central and southern Mexico are reached by trade agreements, poverty can be fought effectively.


<br>


Grumiller (2014) presents a review of several **ex-ante and ex-post studies** of NAFTA's effects. He finds a "... considerable gap [...] between projections and ex-post evaluations with regard to NAFTA's effects on welfare/GDP, wages and employment. Most ex-ante models had a tendency to overestimate the benefits and underestimate the costs of free-trade. (Grumiller (2014)). ..." He also judges that models now are applied to a large extent like the models then. This means that often underlying assumptions still are questionable. Knowing the results of NAFTA now should lead to a rather low credibility of models whose methodology is in a line with those more than 20 years ago. Unfortunately, there are still many ex-ante predictions of free trade effects which are not very reliable. Grumiller (2014) states that supporters of free trade, especially in the context of TTIP, rely on very similar studies to those conducted before NAFTA. He therefore advices policymakers be critical about studies concerning prospects of free trade agreements. Piermartini and Teh (2005) also state that CGE results often are not sufficiently reliable, because the simulations should be reviewed and improved systematically ex-post. Furthermore, they pledge for a better use of sensitivity analyses.  

<br>

A rather **critical view** on NAFTA stems from the Sierra Club (2016). They claim, that NAFTA-like treaties withdraw power from policymakers to regulate in a socially and environmental beneficial way. This led to increasing pollution and resource intensive activities and to a displacement of millions of Mexican peasant farmers. Signing more trade agreements like NAFTA would counteract social and sustainable activities through fostering corporate-dominated governance.



<br>

#### c) TTIP Negotiations


According to Pelkmans et. al (2014), CGE modelling is the best way to assess trade agreements' effects. Despite this, even employing CGE models they judge a comprehensive economic analysis of TTIP to be a vast challenge, if not infeasible, for the following reasons:  
They consider the planned characteristics of TTIP as unusual, since a big focus of the negotiations is on **non-tariff barriers (NTB)** reduction, like regulatory burden ease, in a large scope of markets and segments. The differences in regulatory in the EU and the U.S. are a type of 'iceberg trading costs', the parameter $d^j_{ni}$ in CP's model, see Exercise 2.3 c). Furthermore, they emphasize that NTBs are already crucial to the assessment of a standard free trade agreement,  thus they are even more in the case of TTIP.
Despite the big challenge of properly approximating NTBs and how they would react to a trade treaty, Pelkmans et. al (2014) emphasize that these proxies are indispensable for a meaningful empirical study. These estimates have a considerable impact on producers' reactions on changes in trade costs and hence on final results. They also state that indeed there are analyses which do not use adequate NTBs or their changes. 
In addition to the NTB issues, Pelkmans et. al (2014) judge the imperative to properly address the numerous interactions between sectors, markets, labour markets, goods and services in CGE models to be a tall order.   

See the following info box for why these findings express a limitation of CP.
info("CP and the implications from Pelkmans et. al (2014)") # Run this line (Strg-Enter) to show info

<br>


In the **European Commission project of assessing TTIP** economically, Francois et. al (2013a) publish as a key finding an estimated economic gain for the European Union of 119 billion euros per year as the most optimistic scenario. They translate it as a disposable average family extra income of 545 euros per year, which was broadly published in the media. In contrast, in their own annex, Francois et. al (2013b) state that the value of 119 billion euros corresponds to an estimated increase in GDP by the year 2027. Furthermore, Francois et. al (2013b) explicitly and correctly mention that the estimated increase in GDP does not match real welfare gains. So the striking publication's headline of Francois et. al (2013a) seems to be exaggerated and incomplete, if not wrong. 


Another European Commission (2013) study finds, that a pure tariff reducing trade agreement would lead to up to 0.1% of increase of EU GDP by 2027, given that today tariffs between the EU and the USA are already relatively low. A comprehensive trade agreement, which additionally includes a very ambitious reduction of NTBs, then could lead to up to 0.48% of increase of EU GDP by 2027. They assume eliminating 25% of all non-price and non-quantity barriers to trade in the course of the trade agreement, which still appears very optimistic, consider Anderson and van Wincoop (2004). They in turn suggest that policy barriers stand for only 18% of NTBs, which do not arise from retailing or transporting costs. The remaining 82% of these costs consist of information, language, currency and security barriers. None of them is directly influenced by TTIP. This means that even the unrealistic scenario of removing all NTBs that politics can possibly remove does not lead to an elimination of 25% of NTBs. Hence, their more conservative scenario of reducing 10% of NTBs seems more realistic. This scenario leads to a GDP increase of 0.27% in the EU and 0.21% in the USA by 2027. This translates to an EU GDP increase of annually 0.018% through TTIP, while exports increase by 16% and 23% respectively by 2027. Also consider the discussion on that topic in Exercise 2.3 c) in the note 'Trade costs in EK'.
Raza et. al (2014), too, point out that the European Commission (2013)'s ambitious scenario appears too optimistic. Pelkmans et. al (2014) underline that the choice of NTBs and its reductions are extremely crucial for proper CGE evaluations of international trade. Last but not least, the European Commission (2009) admits that estimating the trade costs of non-price and non-quantity barriers to trade is difficult and that they based their estimations on a survey among EU and U.S companies.

<br>

In their study, Raza et. al (2014) **criticize** several publications that are predicting impacts of TTIP, the European Commission's (2013) study among them. Their objections besides the extremely optimistic model assumptions like NTBs, see above, are the disregard of important issues and the lack of learning effects from NAFTA, confer Grumiller (2014). Issues they put forth are: First, the redirection of intra-EU trade towards the USA could amount to up to 30%. Second, the GDP impact on developing countries is highly negative, -2.8% for Latin America for instance, which is by far a higher percentage loss for those countries than the EU or the USA would gain. Third, in the course of adapting the economies to the new state occur several billion euros of costs to the social systems. The reason is the temporary displacement of 430,000 to 1,100,000 workers which means a temporary unemployment, additional training costs, lost tax contributions and the risk of losing the job permanently, especially for older and less-skilled workers. Fourth, the other studies consider NTBs as adverse to welfare, which means to GDP growth. Raza et. al (2014) in contrast point out that welfare indeed has several pillars next to mere GDP values. They write that NTBs are often welfare-enhancing, because they pursue public objectives like social and environmental corrections of market failures. Another reason for social costs are investor-to-state dispute settlements. On the one hand, they would lead to regulatory acts being cancelled due to the threat of being challenged and on the other hand they could result in compensating companies through public funds in case of litigation.

<br>

#### d) Final Conclusion

This paragraph provides a conclusion of the literature on free trade agreements and in particular of Caliendo and Parro (2015).   
When it comes to modelling trade agreements, it makes sense to use data for many countries and many sectors. In the model, intermediate goods, sectoral linkages and heterogeneous sectors matter. CGE approaches are apparently best suited for capturing the complex interrelations that such models raise. However, proper modelling is an enormous challenge. Especially crucial assumptions like the choice of model specifications and the estimation of non-tariff barriers have a high impact on the models' outcomes. Another issue numerous studies unfortunately do not face is an ex-post model validation which would increase the results' reliability. It seems that there are good arguments to believe that predictions of effects on welfare and trade often are too optimistic. In reality the impact on GDP in general is most likely very modest. If we consider welfare to have social, environmental and other components in addition to monetary ones, even the state-of-the-art models apparently struggle with delivering satisfactory and trustworthy results.  



<br>

Thank you for your interest in this RTutor problem set! Hopefully you gained many interesting insights into the topic of free trade. If you liked it, maybe you are interested in other problem sets promoted by S. Kranz (2015) at: https://github.com/skranz/RTutor.



<br>

<br>

## Exercise Glossary of Terms

CP: Caliendo and Parro (2015)

EK: Eaton and Kortum (2002)

I-O: Input-output

NAFTA: North American Free Trade Agreement

NTB: Non-tariff barriers

PDF: Probability density function

$\tau^j_{ni}$: These are the tariffs on imports by country $n$ from country $i$ imposed on sector $j$ goods.  
For the other variables, the meanings of $n$, $i$ and $j$ are the same.

TTIP: Transatlantic Trade and Investment Partnership

WIOT: World Input Output Table



<br>

<br>

## Exercise References

#### Bibliography

Anderson, J. E. (1979): A Theoretical Foundation for the Gravity Equation. *The American Economic Review, 69*(1), pp. 106-116

Anderson, J. E. & van Wincoop, E. (2004): Trade Costs. *Journal of Economic Literature, 42*(3), pp. 691-751

Baldwin, R. E. & Venables, A. J. (1995): Regional Economic Integration. In: Grossman, G. M. & Rogoff, K., eds., *Handbook of International Economics*, Volume 3, Amsterdam: North-Holland, pp. 1597-1644.

Banco de Mexico (2016): keyword: Annual Report 2006. http://www.banxico.org.mx, p. 154. Last accessed on April 23, 2016

Bureau of Labor Statistics (2016): keyword: Consumer Price Index. http://www.bls.gov/cpi. Last accessed on April 24, 2016

Caliendo, L. & Parro, F. (2015): Estimates of the Trade and Welfare Effects of NAFTA. *The Review of Economic Studies, 82*(1), pp. 1-44

Dietzenbacher, E., Los, B., Stehrer, R., Timmer, M. & De Vries, G. (2013): The Construction of World Input-Output Tables in the WIOD Project. *Economic Systems Research, 25*(1), pp. 71-98

Dornbusch, R., Fischer, S. & Samuelson, P. A. (1997): Comparative Advantage, Trade, and Payments in a Ricardian Model with a Continuum of Goods. *The American Economic Review, 67*(5), pp. 823-839

Eaton, J. & Kortum, S. (2002): Technology, Geography and Trade. *Econometrica, 70*(5), pp. 1741-1779

European Commission (2013): Impact Assessment on the future of the EU-US trade relations accompanying the document "Recommendation for a Council Decision authorising the opening of negotiations on a comprehensive trade and investments agreement, called the Transatlantic Trade and Investment Partnership between the European Union and the United States of America". Staff Working Document 68

--------- (2009): Non-Tariff Measures in EU-US Trade and Investment - An Economic Analysis - Highlights of the study. http://trade.ec.europa.eu/doclib/docs/2009/december/tradoc_145612.pdf. Last accessed on April 25, 2016

Francois, J., Manchin, M., Norberg, H., Pindyuk, O. & Tomberger, P. (2013a): Reducing Transatlantic Barriers to Trade and Investment: An Economic Assessment - Final Project Report. Centre for Economic Policy Research. http://trade.ec.europa.eu/doclib/docs/2013/march/tradoc_150777.pdf. Last accessed on April 24, 2016

--------- (2013b): Reducing Transatlantic Barriers to Trade and Investment: An Economic Assessment - Report Annex. Centre for Economic Policy Research. http://trade.ec.europa.eu/doclib/docs/2013/march/tradoc_150738.pdf. Last accessed on April 24, 2016

Grumiller, J.-A. (2014): Ex-Ante Versus Ex-Post Assessments of the Economic Benefits of Free Trade Agreements: Lessons From the North American Free Trade Agreement (NAFTA). Briefing Paper 10, *Austrian Foundation for Development Research*

Hanson, G. (2003): What happened to Wages in Mexico Since NAFTA? *NBER Working Papers 9563*  

Helpman, E., Melitz, M. & Rubinstein, Y. (2008): Estimating Trade Flows: Trading Partners and Trading Volumes. *The Quarterly Journal of Economics, 123*(2), pp. 441-487

Nicita, A. (2006): Multilateral Trade Liberalization and Mexican Households: The Effect of the Doha Development Agenda. In: Hertel, T. W., & Winters, L. A, eds., *Poverty and the WTO: Impacts of the Doha Development Agenda*, Chapter 4, Washington D.C.: World Bank and Palgrave Macmillan, pp. 107-128  

OECD Glossary (2016): keyword: input-output table. http://stats.oecd.org/glossary/detail.asp?ID=373. Last accessed on April 18, 2016

Pelkmans, J., Lejour, A., Schrefler, L., Mustilli, F., & Timini, J. (2014): The Impact of TTIP - The underlying economic model and comparisons. *Centre for European Policy Studies Special Report, 93*(TTIP Series No. 1),
https://www.ceps.eu/system/files/No%2093%20Appraisal%20of%20IA%20on%20TTIP.pdf. Last accessed on April 22, 2016.

Piermartini, R. & Teh, R. (2005): Demystifying Modelling Methods for Trade Policy. WTO Discussion Papers 10, World Trade Organisation

Raza, W., Grumiller, J., Taylor, L., Troester, B. & von Arnim, R. (2014): ASSESS_TTIP: Assessing the claimed benefits of the Transatlantic Trade and Investment Partnership. *Austrian Foundation for Development Research*. http://www.guengl.eu/uploads/plenary-focus-pdf/ASSESS_TTIP.pdf. Last accessed on April 25, 2016

Romalis, J. (2007): NAFTA's and CUSFTA's Impact on International Trade. *Review of Economics and Statistics, 89*(3), pp. 416-435.

Sierra Club (2016): keyword: NAFTA: 20 Years of Costs to Communities and the Environment. http://www.sierraclub.org. Last accessed on April 19, 2016

Simonovska, I. & Waugh, M.E. (2014): The Elasticity of Trade: Estimates and Evidence. *Journal of International Economics, 92*, pp. 34-50

Timmer, M. P., Dietzenbacher, E., Los, B., Stehrer, R. & de Vries, G. J. (2015): An Illustrated User Guide to the World Input-Output Database: the Case of Global Automotive Production. *Review of International Economics, 23*, pp. 575-605

United Nations (2016): keyword: International Standard Industrial Classification (ISIC) Revision 3, Other Business. http://unstats.un.org/unsd/cr/registry/regcs.asp?Cl=2&Lg=1&Co=74. Last accessed on April 20, 2016

United States Census Bureau (2016): keyword: Trade in Goods with Canada. https://www.census.gov/foreign-trade/balance/c1220.html. Last accessed on April 23, 2016

World Input-Output Database (2016): keyword: World Input-Output Table. http://www.wiod.org/new_site/database/wiots.htm. Last accessed on April 18, 2016


<br>

#### R-Related References

Auguie, B. & Antonov, A. (2015): package gridExtra. Miscellaneous Functions for "Grid" Graphics. https://github.com/baptiste/gridextra

Becker, R. A., Wilks, A. R., Brownrigg, R., Minka, T. P. & Deckmyn, A. (2016): package maps. Draw Geographical Maps

Kranz, S. (2015): package RTutor. Creating R Problem Sets With Automatic Assessment of Student's Solutions. https://github.com/skranz/RTutor 

--------- (2014): package shinyEvents. Shiny Wrapper With Event Handlers Instead of Reactivity. https://github.com/skranz/shinyEvents

Wickham, H. & Chang, W. (2015): package ggplot2. http://ggplot2.org

Wickham, H. & Francois, R. (2015): package dplyr. A Grammar of Data Manipulation. https://github.com/hadley/dplyr

Wickham, H. (2014): package reshape2. Flexibly Reshape Data: A Reboot of the Reshape Package. https://github.com/hadley/reshape

